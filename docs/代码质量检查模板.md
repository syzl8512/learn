# 代码质量检查模板

> 用于 Code Review 和日常质量管理
>
> 项目: 英语分级阅读
>
> 更新时间: 2025-10-25

---

## 1. 代码规范检查清单

### A. TypeScript/JavaScript 规范

- [ ] 所有 TypeScript 类型检查通过 (`npm run type-check`)
- [ ] ESLint 无报错 (`npm run lint`)
- [ ] Prettier 格式正确 (`npm run format`)
- [ ] 无 console.log 调试代码 (除了日志库)
- [ ] 无硬编码密钥或敏感信息
- [ ] 无 any 类型 (除非有注释说明原因)
- [ ] 文件大小 < 300 行 (前端) / < 400 行 (后端)

**优先级**: P0 (必须通过)

### B. 后端 NestJS 规范

- [ ] 遵循 NestJS 项目结构 (module/service/controller)
- [ ] 所有 API 端点有 @ApiOperation() 和 @ApiResponse() 装饰器
- [ ] 异常处理完善 (try-catch + 自定义异常)
- [ ] 日志记录合理 (关键操作、错误、性能)
- [ ] 数据库查询有适当索引
- [ ] API 实现了速率限制 (RateLimit)
- [ ] 输入验证完善 (class-validator)

**优先级**: P0 (必须通过) - 异常处理、输入验证；P1 (建议修复) - 其他项

### C. 前端 Vue/uni-app 规范

- [ ] 组件名称遵循 PascalCase
- [ ] Props 有完整的类型定义和默认值
- [ ] 组件文件大小 < 300 行
- [ ] 避免 v-show/v-if 嵌套过深 (最多 3 层)
- [ ] 列表渲染有唯一的 key
- [ ] 事件处理器有适当的防抖/节流
- [ ] Store 使用 Pinia composition API

**优先级**: P0 (必须通过) - 类型定义、文件大小；P1 (建议修复) - 其他项

---

## 2. 性能检查清单

- [ ] API 响应时间 < 500ms (p95)
- [ ] 页面加载时间 < 2s (4G 模拟)
- [ ] 小程序包体积 < 2MB
- [ ] 数据库查询 < 100ms (p95)
- [ ] 内存占用 < 100MB (单用户)
- [ ] 首屏加载无阻塞脚本
- [ ] 图片已压缩 (JPEG/WebP)
- [ ] CSS 无重复定义
- [ ] JavaScript 无死代码

**优先级**: P1 (建议修复)

**测试工具**:
- API 性能: Postman/Artillery
- 页面性能: Lighthouse/Chrome DevTools
- 包体积: 微信开发者工具
- 数据库: Prisma 查询日志

---

## 3. 测试检查清单

- [ ] 单元测试覆盖率 ≥ 70% (后端业务逻辑)
- [ ] API 测试覆盖率 ≥ 60% (所有 CRUD 操作)
- [ ] 前端组件测试覆盖率 ≥ 50%
- [ ] 工具函数测试覆盖率 ≥ 80%
- [ ] 关键业务流程有 E2E 测试
- [ ] 所有新增功能有对应测试
- [ ] 测试用例命名清晰，包含 should/when/then

**优先级**: P0 (必须通过) - 单元测试通过；P1 (建议修复) - 覆盖率达标

**检查命令**:
```bash
# 后端
cd backend && npm run test:cov

# 前端 (如有)
cd frontend && npm run test:unit
```

---

## 4. 安全检查清单

- [ ] 没有 SQL 注入风险 (使用 Prisma 参数化查询)
- [ ] 没有 XSS 风险 (正确转义用户输入)
- [ ] 没有硬编码密钥 (使用环境变量)
- [ ] API 认证和授权正确 (JWT + permission check)
- [ ] CORS 配置安全 (白名单模式)
- [ ] 敏感操作有日志记录
- [ ] 依赖库没有已知漏洞 (`npm audit`)

**优先级**: P0 (必须通过)

**检查命令**:
```bash
# 检查依赖漏洞
npm audit

# 检查硬编码密钥
grep -r "password\|secret\|key" --include="*.ts" --exclude-dir=node_modules .
```

---

## 5. 文档检查清单

- [ ] 新 API 有 Swagger 文档
- [ ] 复杂逻辑有代码注释
- [ ] 公共方法有 JSDoc 注释
- [ ] README 保持最新
- [ ] 环境变量有说明

**优先级**: P1 (建议修复)

**示例 JSDoc**:
```typescript
/**
 * 获取用户的阅读历史
 * @param userId - 用户 ID
 * @param limit - 返回的最大记录数
 * @returns 阅读历史记录数组
 * @throws {NotFoundException} 用户不存在时抛出
 */
async getUserReadingHistory(userId: string, limit: number): Promise<ReadingHistory[]> {
  // ...
}
```

---

## 6. 架构和设计检查清单

### SOLID 原则检查

- [ ] **单一职责** (SRP): 每个类/模块只有一个变化的原因
- [ ] **开闭原则** (OCP): 对扩展开放，对修改关闭
- [ ] **里氏替换** (LSP): 子类可以替换父类
- [ ] **接口隔离** (ISP): 不依赖不需要的接口
- [ ] **依赖倒置** (DIP): 依赖抽象而不是具体实现

### 代码坏味道检查

- [ ] **僵化性** (Rigidity): 系统难以变更，任何微小的改动都会引发一连串的连锁修改
- [ ] **冗余性** (Redundancy): 同样的代码逻辑在多处重复出现
- [ ] **循环依赖** (Circular Dependency): 两个或多个模块互相纠缠
- [ ] **脆弱性** (Fragility): 对代码一处的修改，导致其他看似无关部分功能的意外损坏
- [ ] **晦涩性** (Obscurity): 代码意图不明，结构混乱
- [ ] **数据泥团** (Data Clump): 多个数据项总是一起出现在不同方法的参数中
- [ ] **不必要的复杂性** (Needless Complexity): 过度设计使系统变得臃肿

### 其他设计检查

- [ ] 模块职责清晰
- [ ] 代码重复最小化 (DRY)
- [ ] 错误处理一致
- [ ] 每层文件夹中的文件不超过 8 个

**优先级**: P0 (必须通过) - 循环依赖、文件数量；P1 (建议修复) - 其他项

---

## 7. Git 提交规范检查

- [ ] 提交信息清晰有意义 (遵循 Conventional Commits)
- [ ] 一个提交只做一件事
- [ ] 没有提交 node_modules/.env 等敏感文件
- [ ] 代码已本地测试通过
- [ ] 分支命名规范 (feature/fix/refactor/docs)

**优先级**: P1 (建议修复)

**提交信息格式**:
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**:
- `feat`: 新功能
- `fix`: 修复 bug
- `refactor`: 重构
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```
feat(reading): 添加阅读进度保存功能

- 实现自动保存阅读位置
- 添加断点续读功能
- 优化保存性能

Closes #123
```

---

## 8. Code Review 建议

### A. 审核者问题清单

在审核代码时，请思考以下问题:

1. **功能性**
   - 这段代码的目的是什么？
   - 是否实现了预期功能？
   - 边界条件是否考虑周全？

2. **简洁性**
   - 有没有更简单的方式实现？
   - 是否存在过度设计？
   - 代码是否易于理解？

3. **健壮性**
   - 错误处理是否完善？
   - 是否有潜在的 null/undefined 问题？
   - 异步操作是否正确处理？

4. **性能**
   - 是否有性能问题？
   - 数据库查询是否高效？
   - 是否有不必要的计算？

5. **安全**
   - 是否有安全漏洞？
   - 用户输入是否验证？
   - 敏感数据是否保护？

6. **规范**
   - 是否符合项目规范？
   - 代码风格是否一致？
   - 命名是否清晰？

7. **测试**
   - 是否有充分的测试？
   - 测试是否覆盖关键路径？
   - 测试是否易于维护？

### B. 常见反馈模板

#### 正面反馈
```markdown
✅ 好的实现，考虑以下改进:
- 建议: [具体建议]
- 原因: [为什么这样更好]
- 示例代码: [可选]
```

#### 需要修改
```markdown
⚠️ 需要修改:
- 问题: [具体问题描述]
- 影响: [可能的影响]
- 建议: [修改建议]
```

#### 严重问题
```markdown
🚫 阻挡合并 - 必须修复:
- 问题: [严重问题描述]
- 风险: [安全/性能/功能风险]
- 修复方案: [必须的修复方案]
```

#### 询问澄清
```markdown
❓ 需要澄清:
- 疑问: [具体疑问]
- 上下文: [为什么有此疑问]
```

### C. Review 最佳实践

1. **及时审核**: 在 PR 提交后 24 小时内完成审核
2. **建设性**: 提供具体的改进建议，而不仅是指出问题
3. **尊重**: 对事不对人，保持专业和友好
4. **学习**: 从优秀的代码中学习，分享知识
5. **完整性**: 不仅看变更的代码，也要理解整体上下文

---

## 9. 按优先级的检查清单

### P0 级别 (必须通过) - 阻挡合并

**代码质量** (7 项)
- [ ] TypeScript 类型检查通过
- [ ] ESLint 无报错
- [ ] 无硬编码密钥
- [ ] 文件大小符合规范 (< 300/400 行)
- [ ] 无 any 类型 (除非注释说明)
- [ ] 输入验证完善
- [ ] 异常处理完善

**安全** (7 项)
- [ ] 无 SQL 注入风险
- [ ] 无 XSS 风险
- [ ] 无硬编码密钥
- [ ] API 认证和授权正确
- [ ] CORS 配置安全
- [ ] 敏感操作有日志
- [ ] 依赖库无已知漏洞

**测试** (1 项)
- [ ] 单元测试通过

**架构** (2 项)
- [ ] 无循环依赖
- [ ] 每层文件夹文件数 ≤ 8 个

**总计**: 17 项

### P1 级别 (建议修复) - 可合并但需跟进

**代码质量** (13 项)
- [ ] Prettier 格式正确
- [ ] 无 console.log
- [ ] 遵循 NestJS 结构
- [ ] API 有 Swagger 装饰器
- [ ] 日志记录合理
- [ ] 数据库查询有索引
- [ ] API 有速率限制
- [ ] 组件命名规范
- [ ] Props 类型完整
- [ ] v-if 嵌套不超过 3 层
- [ ] 列表有唯一 key
- [ ] 事件有防抖/节流
- [ ] 使用 Pinia composition API

**性能** (9 项)
- [ ] API 响应 < 500ms (p95)
- [ ] 页面加载 < 2s
- [ ] 小程序包 < 2MB
- [ ] 数据库查询 < 100ms
- [ ] 内存占用 < 100MB
- [ ] 首屏无阻塞脚本
- [ ] 图片已压缩
- [ ] CSS 无重复
- [ ] JS 无死代码

**测试** (6 项)
- [ ] 单元测试覆盖率 ≥ 70%
- [ ] API 测试覆盖率 ≥ 60%
- [ ] 前端测试覆盖率 ≥ 50%
- [ ] 工具函数覆盖率 ≥ 80%
- [ ] E2E 测试覆盖关键流程
- [ ] 新功能有测试

**文档** (5 项)
- [ ] 新 API 有 Swagger 文档
- [ ] 复杂逻辑有注释
- [ ] 公共方法有 JSDoc
- [ ] README 最新
- [ ] 环境变量有说明

**架构** (6 项)
- [ ] 遵循 SOLID 原则
- [ ] 无冗余代码
- [ ] 无脆弱性
- [ ] 无数据泥团
- [ ] 代码重复最小化
- [ ] 错误处理一致

**Git** (4 项)
- [ ] 提交信息清晰
- [ ] 一个提交一件事
- [ ] 无敏感文件提交
- [ ] 代码已本地测试

**总计**: 43 项

### P2 级别 (可选优化) - 不需要修复

**代码风格** (3 项)
- [ ] 变量命名更清晰
- [ ] 注释更详细
- [ ] 代码组织更合理

**架构优化** (3 项)
- [ ] 可考虑重构以提高可维护性
- [ ] 可考虑抽象公共逻辑
- [ ] 可考虑性能优化

**文档完善** (2 项)
- [ ] 可添加更多示例
- [ ] 可添加设计文档

**总计**: 8 项

---

## 10. 检查清单使用场景

### 场景 1: PR Review (完整检查)

**使用清单**: P0 + P1 完整清单

**流程**:
1. 查看 PR 描述和相关 issue
2. 运行自动化检查 (lint/test/type-check)
3. 使用完整清单逐项检查
4. 提供详细的反馈意见
5. 标记优先级 (P0/P1/P2)
6. 等待修复后再次审核

**时间要求**: 24 小时内完成首次审核

### 场景 2: 日常开发自检 (快速检查)

**使用清单**: P0 清单

**流程**:
1. 开发完成后运行自动化检查
2. 快速过一遍 P0 清单
3. 确保无阻挡问题
4. 提交代码

**时间要求**: 5-10 分钟

### 场景 3: Code Freeze (全面检查)

**使用清单**: P0 + P1 + 性能测试

**流程**:
1. 完整的代码审查
2. 运行性能测试和压力测试
3. 检查所有文档
4. 审查安全配置
5. 验证部署脚本

**时间要求**: 发布前 2-3 天

### 场景 4: 重构审查

**使用清单**: 架构和设计检查清单 + P0

**流程**:
1. 重点检查架构改进
2. 验证无破坏性变更
3. 确保测试覆盖
4. 评估性能影响

### 场景 5: 新人代码审查

**使用清单**: 完整清单 + 教育性反馈

**流程**:
1. 更详细的解释
2. 提供示例代码
3. 推荐学习资源
4. 配对编程辅导

---

## 附录: 自动化检查脚本

### 后端检查脚本

创建 `backend/scripts/code-check.sh`:

```bash
#!/bin/bash

echo "🔍 开始代码质量检查..."

# 类型检查
echo "\n📝 TypeScript 类型检查..."
npm run type-check
if [ $? -ne 0 ]; then
    echo "❌ 类型检查失败"
    exit 1
fi

# Lint 检查
echo "\n🔧 ESLint 检查..."
npm run lint
if [ $? -ne 0 ]; then
    echo "❌ ESLint 检查失败"
    exit 1
fi

# 格式检查
echo "\n💅 Prettier 格式检查..."
npm run format:check
if [ $? -ne 0 ]; then
    echo "❌ 格式检查失败"
    exit 1
fi

# 单元测试
echo "\n🧪 运行单元测试..."
npm run test
if [ $? -ne 0 ]; then
    echo "❌ 测试失败"
    exit 1
fi

# 测试覆盖率
echo "\n📊 检查测试覆盖率..."
npm run test:cov
if [ $? -ne 0 ]; then
    echo "❌ 覆盖率检查失败"
    exit 1
fi

# 安全检查
echo "\n🔒 依赖安全检查..."
npm audit --production
if [ $? -ne 0 ]; then
    echo "⚠️  发现安全漏洞，请检查"
fi

# 检查硬编码密钥
echo "\n🔑 检查硬编码密钥..."
if grep -r "password\|secret\|key" --include="*.ts" --exclude-dir=node_modules src/ | grep -v "// "; then
    echo "⚠️  可能存在硬编码密钥"
fi

echo "\n✅ 代码质量检查完成！"
```

### 前端检查脚本

创建 `miniprogram/scripts/code-check.sh`:

```bash
#!/bin/bash

echo "🔍 开始小程序代码质量检查..."

# 类型检查 (如果使用 TypeScript)
echo "\n📝 TypeScript 类型检查..."
npm run type-check
if [ $? -ne 0 ]; then
    echo "❌ 类型检查失败"
    exit 1
fi

# Lint 检查
echo "\n🔧 ESLint 检查..."
npm run lint
if [ $? -ne 0 ]; then
    echo "❌ ESLint 检查失败"
    exit 1
fi

# 检查包体积
echo "\n📦 检查包体积..."
# 这里可以添加包体积检查逻辑

echo "\n✅ 小程序代码质量检查完成！"
```

### Git Pre-commit Hook

创建 `.husky/pre-commit`:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 运行 pre-commit 检查..."

# 只检查暂存的文件
npm run lint-staged

if [ $? -ne 0 ]; then
    echo "❌ Pre-commit 检查失败，请修复后再提交"
    exit 1
fi

echo "✅ Pre-commit 检查通过"
```

---

## 总结

### 检查项统计

| 级别 | 检查项总数 | 说明 |
|------|-----------|------|
| P0 (必须通过) | 17 项 | 阻挡合并，必须修复 |
| P1 (建议修复) | 43 项 | 可合并但需跟进 |
| P2 (可选优化) | 8 项 | 不需要修复 |
| **总计** | **68 项** | - |

### 按分类统计

| 分类 | P0 | P1 | P2 | 总计 |
|------|----|----|----|----|
| 代码规范 | 7 | 13 | 3 | 23 |
| 性能 | 0 | 9 | 1 | 10 |
| 测试 | 1 | 6 | 0 | 7 |
| 安全 | 7 | 0 | 0 | 7 |
| 文档 | 0 | 5 | 2 | 7 |
| 架构设计 | 2 | 6 | 3 | 11 |
| Git 规范 | 0 | 4 | 0 | 4 |

### 使用建议

1. **日常开发**: 专注 P0 清单 (17 项)，确保基本质量
2. **PR Review**: 使用 P0 + P1 清单 (60 项)，全面保证质量
3. **Code Freeze**: 使用完整清单 (68 项) + 额外性能测试
4. **持续改进**: 定期回顾 P2 清单，规划重构和优化

---

**文档维护**:
- 负责人: 技术负责人
- 更新频率: 每月或有重大变更时
- 反馈渠道: 团队会议 / Issue

**参考资源**:
- [Clean Code](https://github.com/ryanmcdermott/clean-code-javascript)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [NestJS Best Practices](https://docs.nestjs.com/)
