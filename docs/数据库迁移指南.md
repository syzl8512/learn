# 数据库迁移指南

**版本**: 1.0
**日期**: 2025-10-25
**适用于**: Phase 1 开发

---

## 快速开始

### 一键初始化数据库

```bash
# 在项目根目录执行
./scripts/db-setup.sh
```

这个脚本会自动完成以下步骤:
1. 检查 PostgreSQL 是否安装
2. 复制环境变量配置 (如果不存在)
3. 测试数据库连接
4. 执行 Prisma 迁移
5. 生成 Prisma Client
6. (可选) 运行种子数据
7. (可选) 打开 Prisma Studio

---

## 手动迁移步骤

### 步骤 1: 安装依赖

```bash
cd backend
npm install
```

### 步骤 2: 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件,配置数据库连接
nano .env
```

**关键配置**:
```env
DATABASE_URL="postgresql://postgres:your_password@localhost:5432/english_reading?schema=public"
```

### 步骤 3: 创建数据库

如果数据库不存在,需要先创建:

```bash
# 方式 1: 使用 psql 命令
createdb english_reading

# 方式 2: 登录 PostgreSQL 创建
psql -U postgres
CREATE DATABASE english_reading;
\q
```

### 步骤 4: 执行迁移

```bash
# 生成并执行迁移
npx prisma migrate dev --name init

# 如果已有迁移文件,直接部署
npx prisma migrate deploy
```

### 步骤 5: 生成 Prisma Client

```bash
npx prisma generate
```

### 步骤 6: 验证迁移

```bash
# 打开 Prisma Studio 查看数据库
npx prisma studio
```

---

## 常见问题

### Q1: 数据库连接失败

**错误信息**:
```
Error: P1001: Can't reach database server
```

**解决方案**:
1. 确认 PostgreSQL 服务已启动
   ```bash
   # macOS
   brew services start postgresql

   # Linux
   sudo systemctl start postgresql

   # Windows
   # 在服务管理器中启动 PostgreSQL
   ```

2. 检查连接信息是否正确
   - 用户名
   - 密码
   - 主机地址
   - 端口 (默认 5432)
   - 数据库名称

3. 测试连接
   ```bash
   psql -U postgres -h localhost -p 5432 -d english_reading
   ```

---

### Q2: 迁移文件冲突

**错误信息**:
```
Error: Migration `init` already exists
```

**解决方案**:

**选项 1: 重置数据库 (开发环境)**
```bash
npx prisma migrate reset
```
⚠️ 警告: 这会删除所有数据!

**选项 2: 使用不同的迁移名称**
```bash
npx prisma migrate dev --name add_new_fields
```

**选项 3: 解决冲突**
```bash
# 查看迁移状态
npx prisma migrate status

# 标记已应用的迁移
npx prisma migrate resolve --applied <migration_name>
```

---

### Q3: Schema 与数据库不同步

**错误信息**:
```
Error: Schema is not in sync with database
```

**解决方案**:

**方式 1: 创建新迁移**
```bash
npx prisma migrate dev --name sync_schema
```

**方式 2: 直接推送更改 (开发环境)**
```bash
npx prisma db push
```

**方式 3: 重置并重新迁移**
```bash
npx prisma migrate reset
npx prisma migrate dev
```

---

### Q4: Prisma Client 未生成

**错误信息**:
```
Error: @prisma/client did not initialize yet
```

**解决方案**:
```bash
# 生成 Prisma Client
npx prisma generate

# 如果还不行,删除 node_modules 重新安装
rm -rf node_modules
npm install
npx prisma generate
```

---

### Q5: 种子数据导入失败

**错误信息**:
```
Error: Unique constraint failed
```

**解决方案**:

这通常是因为数据已存在。解决方法:

1. 使用 `upsert` 而不是 `create`:
   ```typescript
   await prisma.user.upsert({
     where: { email: 'test@example.com' },
     update: {},
     create: { email: 'test@example.com', ... }
   });
   ```

2. 或者先清空数据:
   ```bash
   npx prisma migrate reset
   npx prisma db seed
   ```

---

## 迁移命令参考

### 开发环境命令

```bash
# 创建新迁移并应用
npx prisma migrate dev --name <migration_name>

# 重置数据库 (删除所有数据)
npx prisma migrate reset

# 查看迁移状态
npx prisma migrate status

# 格式化 schema 文件
npx prisma format

# 验证 schema 文件
npx prisma validate

# 打开数据库管理界面
npx prisma studio
```

### 生产环境命令

```bash
# 部署迁移 (不创建新迁移)
npx prisma migrate deploy

# 解决迁移冲突
npx prisma migrate resolve --applied <migration_name>
npx prisma migrate resolve --rolled-back <migration_name>
```

### 查询和调试

```bash
# 查看数据库差异
npx prisma migrate diff \
  --from-schema-datamodel prisma/schema.prisma \
  --to-schema-datasource prisma/schema.prisma

# 生成 SQL 脚本 (不执行)
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel prisma/schema.prisma \
  --script > migration.sql
```

---

## 种子数据说明

### 种子数据内容

种子数据脚本 (`backend/prisma/seed.ts`) 会创建:

1. **系统配置**
   - AI 模型配置 (DeepSeek)
   - 蓝斯值等级定义

2. **测试用户**
   - Email: test@example.com
   - 蓝斯值: 750 (KET)

3. **测试书籍**
   - Harry Potter and the Philosopher's Stone
   - 原始蓝斯值: 880L

4. **测试章节**
   - Chapter 1: The Boy Who Lived
   - 包含原文版本内容

5. **测试听力**
   - 早上的问候 (初级)
   - 包含字幕数据

### 运行种子数据

```bash
# 方式 1: 使用 Prisma CLI
cd backend
npx prisma db seed

# 方式 2: 直接运行脚本
npx ts-node prisma/seed.ts
```

### 清空数据库

```bash
# 重置数据库 (删除所有数据并重新迁移)
npx prisma migrate reset

# 仅删除数据 (保留表结构)
npx prisma db execute --stdin < truncate_all.sql
```

---

## 备份和恢复

### 备份数据库

```bash
# 备份整个数据库
pg_dump -U postgres -h localhost -p 5432 english_reading > backup.sql

# 仅备份数据 (不包含结构)
pg_dump -U postgres --data-only english_reading > data_backup.sql

# 仅备份结构 (不包含数据)
pg_dump -U postgres --schema-only english_reading > schema_backup.sql
```

### 恢复数据库

```bash
# 恢复整个数据库
psql -U postgres -h localhost -p 5432 english_reading < backup.sql

# 恢复数据
psql -U postgres english_reading < data_backup.sql
```

---

## 数据库性能优化

### 分析查询性能

```bash
# 在 PostgreSQL 中启用查询日志
# 编辑 postgresql.conf:
# log_statement = 'all'
# log_duration = on

# 重启 PostgreSQL
sudo systemctl restart postgresql
```

### 添加索引

在 `schema.prisma` 中添加索引:

```prisma
model User {
  // ...
  @@index([email])
  @@index([lexileScore])
}
```

然后创建迁移:
```bash
npx prisma migrate dev --name add_indexes
```

### 分析表统计信息

```sql
-- 查看表大小
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 分析查询计划
EXPLAIN ANALYZE
SELECT * FROM users WHERE "lexileScore" > 800;
```

---

## 生产环境部署

### 步骤 1: 准备迁移文件

确保所有迁移文件已提交到 Git:
```bash
git add prisma/migrations/
git commit -m "Add database migrations"
```

### 步骤 2: 配置生产环境变量

```env
# 生产环境 .env
DATABASE_URL="postgresql://user:password@production-host:5432/english_reading?schema=public&sslmode=require"
NODE_ENV="production"
```

### 步骤 3: 部署迁移

```bash
# 在生产服务器上
cd backend
npx prisma migrate deploy
npx prisma generate
```

### 步骤 4: 验证部署

```bash
# 检查迁移状态
npx prisma migrate status

# 测试数据库连接
npx prisma db execute --stdin <<< "SELECT 1;"
```

---

## 监控和维护

### 定期维护任务

```sql
-- 更新表统计信息
ANALYZE;

-- 清理死行
VACUUM;

-- 完全清理和分析
VACUUM FULL ANALYZE;

-- 重建索引
REINDEX DATABASE english_reading;
```

### 监控连接数

```sql
SELECT
  count(*),
  state
FROM pg_stat_activity
WHERE datname = 'english_reading'
GROUP BY state;
```

### 监控长时间运行的查询

```sql
SELECT
  pid,
  now() - query_start as duration,
  query
FROM pg_stat_activity
WHERE state = 'active'
  AND now() - query_start > interval '5 seconds'
ORDER BY duration DESC;
```

---

## 相关文档

- [Prisma Schema 详细文档](./Prisma-Schema.md)
- [API 规范](./API-规范.md)
- [环境配置](./环境配置.md)
- [项目初始化清单](./项目初始化清单.md)

---

**文档维护者**: 后端开发团队
**最后更新**: 2025-10-25
**版本**: 1.0
