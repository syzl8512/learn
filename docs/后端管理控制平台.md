# 后端管理控制平台设计文档

**版本**: 1.0
**日期**: 2025-10-25
**用途**: 为内容管理员、运营人员提供完整的数据管理和配置界面
**核心功能**: 书籍导入、预处理、分册、听力制作、模型配置

---

## 📋 目录

1. [平台概述](#平台概述)
2. [功能模块](#功能模块)
3. [用户权限体系](#用户权限体系)
4. [技术架构](#技术架构)
5. [数据库设计扩展](#数据库设计扩展)
6. [API 设计](#api-设计)
7. [前端界面设计](#前端界面设计)

---

## 平台概述

### 定位

**后端管理控制平台** 是专门为内容团队（编辑、运营、技术人员）设计的一体化管理系统，用于：
1. **内容生产**: 上传 PDF → 转 Markdown → 分册 → 生成多档次版本 → 审核发布
2. **听力制作**: 创建题目 → 制作音频 → 导入批量数据 → 审核发布
3. **配置管理**: AI 模型选择、语音服务选择、参数调整
4. **数据监控**: 导入统计、处理进度、系统状态

### 访问方式

```
Web 界面: https://admin.yourdomain.com
移动端: 管理平台 H5 版本 (可选)

认证: 企业微信/钉钉/自有账号体系
权限: 基于角色的访问控制 (RBAC)
```

---

## 功能模块

### 模块 1️⃣: 书籍管理 (BookManagement)

#### 1.1 书籍导入与处理流程

```
┌────────────────────┐
│  PDF 文件上传      │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  MinerU 转 Markdown │ ← 可配置 OCR 参数
│  (后台异步处理)    │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  内容预处理        │ ← 清理格式、去重
│  (质量检查)        │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  自动分章节        │ ← 按标题、篇幅分割
│  (生成章节列表)    │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  编辑审核          │
│  (调整分章结果)    │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  生成多档次版本    │ ← 初级/KET/PET
│  (调用 DeepSeek)   │ ← 模型可配置
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  版本审核与编辑    │
│  (多版本对比)      │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  生成 TTS 音频     │ ← Aliyun/Tencent
│  (后台自动处理)    │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  发布上线          │
│ (内容可见性设置)   │
└────────────────────┘
```

#### 1.2 书籍导入页面

**功能清单**:
- [ ] PDF 文件拖拽上传 (支持多文件)
- [ ] 上传进度条 + 预估时间
- [ ] 书籍基本信息编辑 (书名、作者、介绍、封面)
- [ ] 上传历史查看和重新处理

**后端接口**:

```
POST /admin/api/books/upload
  - 上传 PDF 文件
  - 请求体: file, title, author, description, cover

GET /admin/api/books/uploads/history
  - 查询上传历史
  - 支持分页、搜索、按状态筛选

POST /admin/api/books/{bookId}/reprocess
  - 重新处理已上传的书籍
  - 可修改 OCR 参数
```

#### 1.3 章节管理

**功能清单**:
- [ ] 章节列表展示 (按序号、名称排序)
- [ ] 章节拆分/合并编辑
- [ ] 原文内容编辑 (富文本编辑器)
- [ ] 多版本内容对比查看
- [ ] 生成 TTS 音频

**后端接口**:

```
GET /admin/api/chapters
  - 列表查询章节
  - 参数: bookId, page, limit, status

PATCH /admin/api/chapters/{chapterId}
  - 更新章节信息
  - 请求体: title, sequence, content, status

POST /admin/api/chapters/{chapterId}/regenerate-versions
  - 重新生成多档次版本
  - 请求体: modelVersion, temperature

GET /admin/api/chapters/{chapterId}/versions-compare
  - 多版本内容对比
  - 返回: original vs easy vs ket vs pet 并排展示

POST /admin/api/chapters/{chapterId}/generate-tts
  - 生成 TTS 音频
  - 请求体: voice (xiaoxiao/sasha/etc), speed (0.8-1.2)
```

---

### 模块 2️⃣: 听力制作 (ListeningProduction)

#### 2.1 听力题目创建

**三种创建方式**:

```
方式1: 手动创建单条
  ├─ 填写题目信息 (话题、难度、标题、文本、翻译)
  ├─ 上传或输入音频 URL
  ├─ 添加关键词汇
  └─ 发布或保存草稿

方式2: 批量导入 (Excel/CSV)
  ├─ 上传 Excel 文件
  ├─ 预览和验证
  ├─ 修正错误行
  └─ 批量导入

方式3: 从书籍生成
  ├─ 选择书籍/章节
  ├─ AI 自动生成题目
  ├─ 编辑和审核
  └─ 发布
```

#### 2.2 听力管理页面

**功能清单**:
- [ ] 听力列表 (按话题、难度、发布时间筛选)
- [ ] 听力编辑 (编辑题目、音频、字幕)
- [ ] 听力预览 (播放、字幕同步)
- [ ] 听力统计 (使用数、评分、反馈)
- [ ] 批量操作 (删除、更改难度、发布/下架)

**后端接口**:

```
POST /admin/api/listening/create
  - 创建单条听力
  - 请求体: title, topic, level, transcript, translation, audioUrl, etc

POST /admin/api/listening/import-batch
  - 批量导入听力
  - 请求体: Excel/CSV 文件

POST /admin/api/listening/{listeningId}/generate-from-chapter
  - 从章节生成听力题目
  - 请求体: chapterId, count (生成多少条)

GET /admin/api/listening
  - 列表查询
  - 参数: page, limit, topic, level, status

PATCH /admin/api/listening/{listeningId}
  - 编辑听力
  - 请求体: 任意字段

DELETE /admin/api/listening/{listeningId}
  - 删除听力

PATCH /admin/api/listening/batch-action
  - 批量操作
  - 请求体: ids, action (delete/publish/unpublish), data
```

---

### 模块 3️⃣: 操作事项 (Tasks/Queue)

实时显示后台异步任务的处理进度：

#### 3.1 任务队列系统

```
任务类型:
├─ PDF 转 Markdown (status: processing/completed/failed)
├─ AI 生成版本 (status: processing/completed/failed)
├─ 生成 TTS 音频 (status: processing/completed/failed)
├─ 批量导入听力 (status: processing/completed/failed)
└─ 数据备份 (status: processing/completed/failed)

任务显示:
├─ 任务类型 + 名称
├─ 进度百分比 (0-100%)
├─ 执行时间
├─ 状态标签 (等待中/处理中/已完成/失败)
├─ 错误信息 (如果失败)
└─ 操作按钮 (重试/查看详情/删除)
```

**后端接口**:

```
GET /admin/api/tasks
  - 查询任务列表
  - 参数: status, type, page, limit
  - 返回: 实时任务列表

GET /admin/api/tasks/{taskId}
  - 获取任务详情
  - 返回: 完整的进度信息和日志

POST /admin/api/tasks/{taskId}/retry
  - 重试失败的任务

DELETE /admin/api/tasks/{taskId}
  - 删除已完成的任务

WebSocket /admin/ws/tasks
  - WebSocket 推送实时任务更新
  - 用于前端实时显示进度
```

---

### 模块 4️⃣: 模型配置 (ModelConfiguration)

#### 4.1 可配置的 AI 模型

```
内容生成模型 (Content Generation):
  ├─ 当前选择: DeepSeek Chat (deepseek-chat)
  ├─ 备选方案:
  │  ├─ OpenAI GPT-4 (gpt-4)
  │  ├─ Claude 3.5 Sonnet (claude-3-5-sonnet)
  │  └─ Ollama 本地模型 (llama2, qwen, etc)
  │
  └─ 配置参数:
     ├─ Temperature (0.0-1.0) - 创意度
     ├─ Max Tokens (100-4000)
     ├─ Top P (0.0-1.0)
     └─ Frequency Penalty (0.0-2.0)

语音合成模型 (TTS):
  ├─ 当前选择: 阿里云 TTS
  ├─ 备选方案:
  │  ├─ 腾讯云 TTS
  │  └─ Azure Speech Services
  │
  └─ 配置参数:
     ├─ 语音角色 (xiaoxiao/sasha/etc)
     ├─ 语速 (0.5-2.0)
     ├─ 音量 (0.0-1.0)
     └─ 音频格式 (mp3/wav/pcm)

内容难度评估模型 (Lexile Assessment):
  ├─ 方式1: Lexile 官方 API (调用)
  ├─ 方式2: LLM 提示词推估 (DeepSeek)
  └─ 方式3: 本地词汇表 (开源库)
```

#### 4.2 模型配置页面

**功能清单**:
- [ ] 模型选择下拉框 (内容生成/TTS/评估)
- [ ] API Key 管理 (加密存储)
- [ ] 参数调整滑块 (Temperature/Speed/etc)
- [ ] 模型对比测试 (输入文本，对比多个模型输出)
- [ ] 模型性能统计 (响应时间、成功率、成本)

**后端接口**:

```
GET /admin/api/config/models
  - 获取当前模型配置
  - 返回: 所有配置项和可用选项

PATCH /admin/api/config/models
  - 更新模型配置
  - 请求体: contentModel, ttsModel, parameters

POST /admin/api/config/models/test
  - 测试模型输出
  - 请求体: model, testInput, parameters
  - 返回: 多个模型的输出对比

GET /admin/api/config/models/performance
  - 获取模型性能统计
  - 返回: 响应时间、成本、成功率数据

POST /admin/api/config/api-keys
  - 管理 API Key
  - 请求体: service, key, secret (加密)

GET /admin/api/config/api-keys
  - 列表 API Key
  - 返回: 脱敏的 Key 列表
```

---

### 模块 5️⃣: 数据监控与统计 (Monitoring)

#### 5.1 系统仪表板

```
实时指标:
├─ 系统状态 (后端/数据库/Redis 运行状态)
├─ 当日数据统计
│  ├─ 新增用户
│  ├─ 新增书籍
│  ├─ 新增听力内容
│  └─ 学习总时长
│
├─ 内容库规模
│  ├─ 书籍总数
│  ├─ 章节总数
│  ├─ 听力内容总数
│  └─ 总字数/分钟数
│
├─ 处理队列状态
│  ├─ 待处理任务数
│  ├─ 处理中任务数
│  └─ 失败任务数
│
└─ 系统性能
   ├─ API 响应时间
   ├─ 数据库查询性能
   └─ 磁盘使用率
```

**后端接口**:

```
GET /admin/api/dashboard/stats
  - 获取实时统计数据
  - 返回: 各类指标的实时值

GET /admin/api/dashboard/trends
  - 获取数据趋势
  - 参数: period (day/week/month), metric (users/books/listening)
  - 返回: 时间序列数据用于绘图

GET /admin/api/dashboard/system-health
  - 获取系统健康状态
  - 返回: 各个组件的状态指标
```

---

## 用户权限体系

### 角色定义

| 角色 | 权限 | 适用场景 |
|------|------|---------|
| **管理员** | 所有权限 | 系统管理员、技术主管 |
| **内容编辑** | 书籍导入、编辑、发布；听力创建、编辑、发布 | 编辑、运营 |
| **审核员** | 查看、批准/驳回内容；无编辑权限 | 质量审查人员 |
| **数据分析** | 查看统计数据、报表；无修改权限 | 数据分析师 |
| **配置管理员** | 配置 API Key、模型选择、系统参数 | 技术运维人员 |

### 权限矩阵

```
功能模块          | 管理员 | 编辑 | 审核员 | 分析 | 配置管理
─────────────────┼────────┼────┼──────┼───┼────────
书籍上传          | ✓      | ✓  | ✗    | ✗ | ✗
书籍编辑/删除      | ✓      | ✓  | ✗    | ✗ | ✗
书籍审核/发布      | ✓      | ✗  | ✓    | ✗ | ✗
听力创建/编辑      | ✓      | ✓  | ✗    | ✗ | ✗
听力审核/发布      | ✓      | ✗  | ✓    | ✗ | ✗
查看统计数据       | ✓      | ✓  | ✗    | ✓ | ✓
配置 AI 模型       | ✓      | ✗  | ✗    | ✗ | ✓
配置 API Key       | ✓      | ✗  | ✗    | ✗ | ✓
删除数据           | ✓      | ✗  | ✗    | ✗ | ✗
```

---

## 技术架构

### 前端技术栈

```
框架: Vue 3 + TypeScript + Vite
UI 库: Element Plus (企业级 UI)
状态管理: Pinia
HTTP 客户端: axios + 自定义请求拦截器
图表库: ECharts (数据可视化)
文件上传: vue-uploader
富文本编辑: Quill / TinyMCE
代码编辑: Monaco Editor (语言配置查看)
实时推送: Socket.io (任务进度)
```

### 后端技术栈

```
框架: NestJS + TypeScript
ORM: Prisma
数据库: PostgreSQL 16 + Redis
任务队列: Bull + Redis
文件处理: sharp (图片), pdf-parse (PDF)
OCR: MinerU 调用脚本
语音合成: Aliyun TTS SDK
AI 调用: OpenAI SDK, Anthropic SDK, DeepSeek API
认证: JWT + RBAC 中间件
日志: Winston (分级日志)
文件存储: 阿里云 OSS SDK
容器化: Docker + Docker Compose
```

### 部署架构

```
┌─────────────────┐
│  管理员浏览器   │
└────────┬────────┘
         │ HTTPS
         ▼
┌─────────────────┐
│  Nginx 反向代理  │
└────────┬────────┘
         │
    ┌────┴────────┐
    │ 前端 H5     │ 后端 API
    ▼             ▼
┌────────┐  ┌──────────────┐
│ Vue 3  │  │  NestJS      │
│ 应用   │  │  服务器      │
└────────┘  └──────┬───────┘
                   │
           ┌───────┼────────┐
           │       │        │
           ▼       ▼        ▼
        PostgreSQL Redis  OSS
         数据库   缓存   文件存储
```

---

## 数据库设计扩展

### 新增表

```prisma
// 模型配置
model AIModelConfig {
  id              String @id @default(cuid())
  modelType       String  // content_generation|tts|lexile_assessment
  provider        String  // deepseek|openai|anthropic|aliyun|etc
  modelName       String  // deepseek-chat, gpt-4, etc
  apiKey          String  @db.Text // 加密存储
  apiSecret       String? @db.Text // 加密存储
  apiUrl          String
  isActive        Boolean @default(true)

  // 参数配置
  temperature     Float @default(0.3)
  maxTokens       Int @default(2000)
  topP            Float @default(0.9)
  frequencyPenalty Float @default(0.0)

  // 统计
  totalRequests   Int @default(0)
  successCount    Int @default(0)
  failureCount    Int @default(0)
  avgResponseTime Float @default(0) // 毫秒
  totalCost       Float @default(0) // 人民币

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([modelType, provider, modelName])
}

// 后台管理员
model AdminUser {
  id              String @id @default(cuid())
  username        String @unique
  passwordHash    String
  email           String @unique
  roles           String[] // admin, editor, reviewer, analyst, config_manager
  isActive        Boolean @default(true)
  lastLoginAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 操作日志
model OperationLog {
  id              String @id @default(cuid())
  userId          String
  action          String  // create_book, edit_chapter, publish_listening, etc
  resourceType    String  // book, chapter, listening, config
  resourceId      String
  changes         Json    // 变更的字段和值
  ipAddress       String
  userAgent       String

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([resourceType, resourceId])
}

// 处理任务队列
model ProcessingTask {
  id              String @id @default(cuid())
  taskType        String  // pdf_convert, ai_generation, tts_generation, batch_import
  status          String  // pending|processing|completed|failed
  progress        Int @default(0) // 0-100

  // 输入参数
  inputData       Json

  // 输出结果
  outputData      Json?
  errorMessage    String?

  // 执行信息
  startedAt       DateTime?
  completedAt     DateTime?
  executionTime   Int? // 毫秒

  // 关联
  userId          String
  resourceId      String?
  resourceType    String?

  createdAt       DateTime @default(now())

  @@index([status])
  @@index([userId])
  @@index([taskType])
}

// 审批工作流
model ApprovalWorkflow {
  id              String @id @default(cuid())
  resourceType    String  // book|listening
  resourceId      String
  status          String  // pending|approved|rejected

  submittedBy     String
  submittedAt     DateTime @default(now())

  approvedBy      String?
  approvedAt      DateTime?
  approvalComment String?

  @@unique([resourceType, resourceId])
}
```

---

## API 设计

### 书籍管理 API

```
POST /admin/api/books/upload
  上传 PDF 并启动处理流程
  返回: { bookId, status: "processing", progressUrl }

GET /admin/api/books/{bookId}/process-progress
  查询书籍处理进度
  返回: { status, progress, currentStep, eta }

PATCH /admin/api/chapters/{chapterId}/content
  更新章节原文内容
  请求: { content }

POST /admin/api/chapters/{chapterId}/regenerate-versions
  重新生成多档次版本
  请求: { modelConfig, overwrite }
  返回: { taskId, status: "processing" }
```

### 听力管理 API

```
POST /admin/api/listening/create
  创建单条听力
  请求: { title, topic, level, transcript, translation, audioUrl, ... }

POST /admin/api/listening/batch-import
  批量导入
  请求: { file(Excel) }

GET /admin/api/listening/{id}
  获取听力详情
  返回: 完整的听力信息

PATCH /admin/api/listening/{id}
  编辑听力
  请求: { 需要修改的字段 }

DELETE /admin/api/listening/{id}
  删除听力

PATCH /admin/api/listening/batch-action
  批量操作
  请求: { ids, action: "delete|publish|unpublish", data }
```

### 任务队列 API

```
GET /admin/api/tasks
  查询任务列表
  参数: status, type, page, limit
  返回: 分页的任务列表

GET /admin/api/tasks/{taskId}
  获取任务详情
  返回: 完整的任务信息和实时日志

POST /admin/api/tasks/{taskId}/retry
  重试失败任务

WebSocket /admin/ws/tasks
  实时推送任务更新
  消息: { taskId, progress, status, message }
```

### 模型配置 API

```
GET /admin/api/config/models
  获取所有模型配置

PATCH /admin/api/config/models/{configId}
  更新模型配置
  请求: { temperature, maxTokens, isActive, ... }

POST /admin/api/config/models/test
  测试模型
  请求: { model, testInput, parameters }
  返回: { output, responseTime, cost }

POST /admin/api/config/api-keys
  添加/更新 API Key
  请求: { service, key, secret } (加密)

GET /admin/api/config/models/performance
  获取模型性能数据
  返回: { avgResponseTime, successRate, totalCost, ... }
```

---

## 前端界面设计

### 页面导航结构

```
/admin
├── /dashboard                    # 主仪表板
│   ├── 实时统计卡片
│   ├── 任务队列实时显示
│   └── 性能监控图表
│
├── /books                        # 书籍管理
│   ├── /list                     # 书籍列表
│   ├── /upload                   # 上传新书
│   ├── /[bookId]/edit            # 编辑书籍
│   └── /[bookId]/chapters        # 章节管理
│
├── /chapters                     # 章节管理 (跳转)
│   ├── /[chapterId]/edit         # 编辑章节
│   ├── /[chapterId]/versions     # 多版本对比
│   └── /[chapterId]/tts          # 生成音频
│
├── /listening                    # 听力管理
│   ├── /list                     # 听力列表
│   ├── /create                   # 创建新题目
│   ├── /[listeningId]/edit       # 编辑题目
│   ├── /import                   # 批量导入
│   └── /from-chapter             # 从章节生成
│
├── /config                       # 系统配置
│   ├── /models                   # AI 模型配置
│   ├── /api-keys                 # API Key 管理
│   ├── /users                    # 用户管理
│   └── /roles                    # 角色权限
│
├── /tasks                        # 任务队列
│   └── /[taskId]/detail          # 任务详情
│
├── /logs                         # 操作日志
│   └── /[id]/detail              # 日志详情
│
└── /settings                     # 个人设置
    └── /account                  # 账号设置
```

### 关键页面设计

#### 书籍上传页面

```
┌─────────────────────────────────────────────┐
│ 📚 上传新书                                  │
├─────────────────────────────────────────────┤
│                                              │
│  PDF 文件拖拽区域:                           │
│  ┌──────────────────────────────────────┐   │
│  │  拖拽 PDF 或点击选择                   │   │
│  │  最大 100MB                          │   │
│  └──────────────────────────────────────┘   │
│                                              │
│  书籍信息:                                   │
│  书名: [________________]                    │
│  作者: [________________]                    │
│  简介: [_____________________]               │
│                                              │
│  OCR 参数:                                   │
│  ☑ 自动识别图文混合                          │
│  ☑ 自动清理格式                              │
│                                              │
│  [取消]                            [上传]    │
└─────────────────────────────────────────────┘
```

#### 章节编辑页面 (多版本对比)

```
┌──────────────────────────────────────────────────────┐
│ 第 3 章: Harry's First Day | 编辑 | 预览             │
├──────────────────────────────────────────────────────┤
│                                                       │
│  版本切换: [原文] [初级] [KET] [PET]                  │
│                                                       │
│  ┌─────────────────────────────────────────────┐    │
│  │ 原文内容 (Original)                         │    │
│  │ [富文本编辑器]                              │    │
│  │                                             │    │
│  │ The boy walked slowly into the castle...   │    │
│  │                                             │    │
│  │ [重新生成版本] [生成音频] [保存]             │    │
│  └─────────────────────────────────────────────┘    │
│                                                       │
│  ┌─────────────────────────────────────────────┐    │
│  │ 初级版本 (Easy, 600-800L) 对比查看           │    │
│  │                                             │    │
│  │ The boy walked into the big castle...      │    │
│  │ [编辑] [刷新] [保存]                        │    │
│  └─────────────────────────────────────────────┘    │
│                                                       │
└──────────────────────────────────────────────────────┘
```

#### 模型配置页面

```
┌──────────────────────────────────────────────┐
│ ⚙️ AI 模型配置                               │
├──────────────────────────────────────────────┤
│                                              │
│ 【内容生成模型】                              │
│ 当前: [DeepSeek Chat ▼]                     │
│ 可选: OpenAI GPT-4, Claude 3.5, etc        │
│                                              │
│ Temperature:  [████░░░░] 0.3               │
│ Max Tokens:   [████░░░░] 2000              │
│ Top P:        [█████░░░] 0.9               │
│                                              │
│ [测试输出]  [保存配置]                       │
│                                              │
│ ───────────────────────────────────────────│
│                                              │
│ 【语音合成模型】                              │
│ 当前: [阿里云 TTS ▼]                       │
│ 可选: 腾讯云, Azure Speech Services        │
│                                              │
│ 语音角色: [xiaoxiao ▼]                     │
│ 语速:     [████░░░░] 1.0x                 │
│ 音量:     [█████░░░] 1.0                  │
│                                              │
│ [试听效果]  [保存配置]                       │
│                                              │
│ ───────────────────────────────────────────│
│                                              │
│ 【性能统计】                                  │
│ 平均响应时间: 2.5s                           │
│ 成功率: 99.2%                               │
│ 今月成本: ¥450.20                           │
│                                              │
└──────────────────────────────────────────────┘
```

---

## 实现时间表

| 阶段 | 功能 | 工作量 | 优先级 |
|------|------|--------|--------|
| Phase 1 (2周) | 基础框架 + 书籍上传/编辑 | 10人天 | P0 |
| Phase 2 (1周) | 听力管理 + 批量导入 | 6人天 | P0 |
| Phase 3 (1周) | 任务队列 + 进度显示 | 5人天 | P1 |
| Phase 4 (1周) | 模型配置 + 参数调整 | 5人天 | P1 |
| Phase 5 (3天) | 权限管理 + 审批流程 | 3人天 | P2 |
| Phase 6 (3天) | 监控仪表板 + 报表 | 3人天 | P2 |

---

**维护者**: 全栈开发团队
**最后更新**: 2025-10-25
