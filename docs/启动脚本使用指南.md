# 启动脚本使用指南

## 概述

本项目提供了完整的启动脚本系统，用于简化开发、构建和部署流程。所有脚本都位于 `scripts/` 目录下，遵循统一的命名和使用规范。

## 脚本列表

| 脚本名称 | 功能描述 | 使用场景 |
|---------|---------|---------|
| `dev.sh` | 开发环境一键启动 | 日常开发 |
| `db-setup.sh` | 数据库初始化 | 首次配置、数据库重置 |
| `build.sh` | 项目构建 | 生产部署前 |
| `clean.sh` | 清理临时文件和容器 | 环境清理、重置 |

---

## 1. dev.sh - 开发环境一键启动

### 功能

- 检查 Node.js 版本 (>= 18)
- 检查并启动 Docker 容器 (PostgreSQL + Redis)
- 等待数据库就绪
- 运行数据库迁移
- 同时启动后端和前端开发服务器
- 输出访问 URL

### 使用方法

```bash
# 完整启动 (推荐)
./scripts/dev.sh

# 跳过 Docker 启动 (容器已运行)
./scripts/dev.sh --skip-docker

# 跳过数据库迁移
./scripts/dev.sh --skip-migration

# 仅启动后端
./scripts/dev.sh --backend-only

# 仅启动前端
./scripts/dev.sh --frontend-only

# 查看帮助
./scripts/dev.sh --help
```

### 首次运行步骤

```bash
# 1. 复制环境变量模板
cp .env.example .env

# 2. 编辑 .env 文件，填写必要配置
vim .env  # 或使用其他编辑器

# 3. 启动开发环境
./scripts/dev.sh
```

### 访问地址

启动成功后，可访问以下地址：

- 后端 API: http://localhost:3000
- Swagger 文档: http://localhost:3000/api-docs
- 前端应用: http://localhost:3001
- 小程序开发: http://localhost:8080

### 停止服务

按 `Ctrl+C` 停止所有服务

---

## 2. db-setup.sh - 数据库初始化

### 功能

- 检查 PostgreSQL 连接
- 创建数据库
- 运行 Prisma migrate 迁移
- 运行 seed 脚本插入测试数据
- 验证迁移成功

### 使用方法

```bash
# 首次初始化数据库
./scripts/db-setup.sh

# 初始化并插入测试数据
./scripts/db-setup.sh --seed

# 重置数据库 (删除所有数据，谨慎使用！)
./scripts/db-setup.sh --reset

# 仅运行迁移
./scripts/db-setup.sh --migrate-only

# 查看帮助
./scripts/db-setup.sh --help
```

### 注意事项

1. 确保 Docker 容器已启动
2. 确保 `.env` 文件已正确配置
3. `--reset` 选项会删除所有数据，请谨慎使用

### 数据库管理

```bash
# 查看数据库
docker exec -it english-reading-postgres psql -U postgres -d english_reading

# 使用 Prisma Studio
npx prisma studio

# 查看数据库日志
docker logs english-reading-postgres
```

---

## 3. build.sh - 项目构建

### 功能

- 检查环境变量完整性
- 构建后端 (NestJS)
- 构建前端小程序 (uni-app)
- 输出构建产物路径
- 显示包体积分析

### 使用方法

```bash
# 完整构建 (生产环境)
./scripts/build.sh

# 仅构建后端
./scripts/build.sh --backend-only

# 仅构建前端
./scripts/build.sh --frontend-only

# 预发布环境构建
./scripts/build.sh --staging

# 生成包体积分析报告
./scripts/build.sh --analyze

# 查看帮助
./scripts/build.sh --help
```

### 构建产物

- 后端构建产物: `dist/backend/`
- 小程序构建产物: `dist/build/mp-weixin/`
- 构建信息文件: `dist/build-info.json`

### 体积限制

- 小程序主包: < 2MB (超过会有警告)
- 建议使用分包加载和资源优化

---

## 4. clean.sh - 清理脚本

### 功能

- 停止 Docker 容器
- 清理 Docker 卷 (可选)
- 清理构建产物
- 清理缓存文件
- 清理日志文件
- 清理 node_modules (可选)

### 使用方法

```bash
# 标准清理 (停止容器 + 清理临时文件)
./scripts/clean.sh

# 完全清理 (包括 Docker 卷和 node_modules)
./scripts/clean.sh --all

# 仅停止 Docker 容器
./scripts/clean.sh --docker

# 仅清理缓存
./scripts/clean.sh --cache

# 仅清理构建产物
./scripts/clean.sh --build

# 仅清理日志文件
./scripts/clean.sh --logs

# 查看帮助
./scripts/clean.sh --help
```

### 注意事项

1. 默认不清理 Docker 数据卷 (保留数据库数据)
2. `--all` 选项会删除所有数据，请谨慎使用
3. 清理后需要重新运行 `./scripts/dev.sh` 启动项目

---

## 配置文件说明

### docker-compose.yml

Docker 容器配置文件，定义了以下服务：

- **PostgreSQL 16**: 主数据库
  - 端口: 5432
  - 数据卷: `postgres_data`
  - 健康检查: 自动检测就绪状态

- **Redis 7**: 缓存和队列
  - 端口: 6379
  - 数据卷: `redis_data`
  - 最大内存: 512MB

### .env.example

环境变量模板，包含以下配置：

1. **应用配置**: NODE_ENV, PORT
2. **数据库配置**: DATABASE_URL, DB_HOST, DB_PORT
3. **Redis 配置**: REDIS_HOST, REDIS_PORT
4. **JWT 配置**: JWT_SECRET, JWT_EXPIRES_IN
5. **微信小程序**: WECHAT_APP_ID, WECHAT_APP_SECRET
6. **DeepSeek AI**: DEEPSEEK_API_KEY
7. **阿里云 TTS**: ALIYUN_ACCESS_KEY_ID
8. **MinerU PDF**: MINERU_API_KEY
9. **日志配置**: LOG_LEVEL, LOG_DIR

---

## 常见问题

### 1. 脚本权限错误

```bash
# 错误: Permission denied
chmod +x scripts/*.sh
```

### 2. Docker 容器无法启动

```bash
# 检查 Docker 是否运行
docker ps

# 查看容器日志
docker logs english-reading-postgres

# 重启 Docker Desktop (macOS)
```

### 3. 数据库连接失败

```bash
# 检查数据库配置
cat .env | grep DATABASE_URL

# 测试数据库连接
docker exec -it english-reading-postgres pg_isready
```

### 4. 端口已被占用

```bash
# 查找占用端口的进程 (以 3000 为例)
lsof -i :3000

# 停止进程
kill -9 <PID>
```

### 5. Node.js 版本过低

```bash
# 检查当前版本
node -v

# 安装 Node.js 18+
# macOS: brew install node@18
# 或访问: https://nodejs.org/
```

---

## 开发流程

### 日常开发流程

```bash
# 1. 启动开发环境
./scripts/dev.sh

# 2. 编写代码...

# 3. 停止服务 (Ctrl+C)

# 4. 清理临时文件
./scripts/clean.sh
```

### 数据库变更流程

```bash
# 1. 修改 Prisma schema
vim prisma/schema.prisma

# 2. 生成迁移
npx prisma migrate dev --name your_migration_name

# 3. 重新生成 Client
npx prisma generate

# 4. 重启开发环境
./scripts/dev.sh
```

### 生产部署流程

```bash
# 1. 确保环境变量完整
cat .env.production

# 2. 构建项目
./scripts/build.sh --production

# 3. 验证构建产物
ls -lh dist/

# 4. 部署到服务器
# (具体步骤根据部署平台而定)
```

---

## 脚本设计原则

1. **简洁高效**: 一键启动，无需手动配置
2. **彩色输出**: 清晰的日志分级 (INFO/SUCCESS/WARNING/ERROR)
3. **错误处理**: 遇到错误立即退出，输出详细信息
4. **健康检查**: 自动等待数据库就绪
5. **灵活配置**: 支持多种启动选项
6. **兼容性**: 支持 macOS 和 Linux

---

## 技术栈

- **容器化**: Docker + Docker Compose
- **数据库**: PostgreSQL 16
- **缓存**: Redis 7
- **后端**: NestJS (Node.js >= 18)
- **前端**: uni-app (微信小程序)
- **ORM**: Prisma

---

## 获取帮助

每个脚本都支持 `--help` 参数查看详细使用说明：

```bash
./scripts/dev.sh --help
./scripts/db-setup.sh --help
./scripts/build.sh --help
./scripts/clean.sh --help
```

---

## 贡献指南

如果您发现脚本存在问题或有改进建议，欢迎提交 Issue 或 Pull Request。

---

**文档版本**: v1.0
**创建时间**: 2025-10-25
**最后更新**: 2025-10-25
**维护者**: Claude Code
