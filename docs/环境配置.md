# 环境配置指南

**版本**: 1.0
**日期**: 2025-10-25
**用途**: 本地开发和生产部署环境配置

---

## 📋 目录

1. [本地开发环境](#本地开发环境)
2. [DeepSeek API 配置](#deepseek-api-配置)
3. [阿里云 TTS 配置](#阿里云-tts-配置)
4. [微信小程序配置](#微信小程序配置)
5. [数据库配置](#数据库配置)
6. [Redis 配置](#redis-配置)
7. [生产环境配置](#生产环境配置)
8. [故障排查](#故障排查)

---

## 本地开发环境

### 系统要求

**最低配置**:
- macOS 12+ / Windows 11+ / Ubuntu 20.04+
- 8GB RAM (建议16GB)
- 50GB 可用磁盘空间
- 网络连接 (国内用户需确保能访问 DeepSeek/Aliyun)

### 必需软件

```bash
# Node.js 18+ (使用 nvm 管理版本)
nvm install 18.17.0
nvm use 18.17.0
node --version  # v18.17.0

# Python 3.8+ (用于 PDF 处理)
python3 --version  # Python 3.8+

# Docker & Docker Compose
docker --version    # Docker 24.0+
docker-compose --version  # Docker Compose v2.20+

# Git
git --version  # git 2.40+
```

### 快速安装脚本 (macOS)

```bash
# 使用 Homebrew
brew install node@18 python@3.10 docker

# 使用 nvm (推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18.17.0
```

### IDE & 开发工具

**推荐 VS Code 扩展**:
- ES7+ React/Redux/React-Native snippets
- Prettier Code Formatter
- ESLint
- Volar (Vue 3 官方)
- Thunder Client (API测试)

**其他工具**:
- 微信开发者工具 (小程序调试)
- Postman / Insomnia (API测试)
- DBeaver (数据库管理)

### 项目依赖安装

```bash
cd /Users/zhangliang/Desktop/英语分级阅读

# 后端依赖
cd backend
npm install

# 前端依赖
cd ../frontend
npm install
```

---

## DeepSeek API 配置

### 1. 申请 API Key

**官网**: https://platform.deepseek.com/

**步骤**:
1. 访问官网，点击「开发者平台」
2. 使用邮箱或微信注册账号
3. 进入「API Key」管理页面
4. 点击「创建新API Key」
5. 复制 API Key (仅显示一次，妥善保管)

**示例 API Key**:
```
sk-...您的api key...
```

### 2. 后端配置

**创建文件**: `backend/.env.local`

```env
# DeepSeek API 配置
DEEPSEEK_API_KEY=sk_your_api_key_here
DEEPSEEK_API_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_MAX_TOKENS=2000
DEEPSEEK_TIMEOUT=30000

# 内容适配配置
AI_ADAPTATION_ENABLED=true
AI_ADAPTATION_TIMEOUT=60000  # 60秒超时
```

### 3. 前端配置 (可选，敏感操作走后端)

**创建文件**: `frontend/.env.development`

```env
TARO_APP_DEEPSEEK_ENABLED=false
# 前端一般不直接调用DeepSeek，通过后端代理
```

### 4. API 使用示例

**后端 NestJS 集成**:

```typescript
// src/services/deepseek.service.ts
import { Injectable } from '@nestjs/common';
import axios from 'axios';

@Injectable()
export class DeepSeekService {
  private apiKey = process.env.DEEPSEEK_API_KEY;
  private apiUrl = process.env.DEEPSEEK_API_URL;
  private model = process.env.DEEPSEEK_MODEL;

  async adaptContent(
    originalText: string,
    targetLexile: number,
  ): Promise<string> {
    const messages = [
      {
        role: 'system',
        content: `你是一个英语内容难度适配专家。你的任务是将英文文本适配到特定蓝斯值难度。

目标蓝斯值: ${targetLexile}L
要求:
1. 保持原意，简化复杂词汇和句式
2. 句子长度保持合理（10-15词）
3. 避免使用生僻词汇
4. 保持故事逻辑连贯`,
      },
      {
        role: 'user',
        content: `请将以下文本适配到${targetLexile}L难度:\n\n${originalText}`,
      },
    ];

    try {
      const response = await axios.post(
        `${this.apiUrl}/chat/completions`,
        {
          model: this.model,
          messages,
          max_tokens: parseInt(process.env.DEEPSEEK_MAX_TOKENS),
          temperature: 0.3,
        },
        {
          headers: {
            Authorization: `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json',
          },
          timeout: parseInt(process.env.DEEPSEEK_TIMEOUT),
        },
      );

      return response.data.choices[0].message.content;
    } catch (error) {
      console.error('DeepSeek API error:', error);
      throw new Error('内容适配失败');
    }
  }

  async assessLexileFromWords(words: string[]): Promise<number> {
    const messages = [
      {
        role: 'system',
        content: `你是一个英语难度评估专家。根据用户掌握的单词，评估其英语水平对应的蓝斯值。

蓝斯值范围:
- 初级 (400-600L): 6-8岁
- KET (600-900L): 8-10岁
- PET (900-1200L): 10-12岁

返回格式: 仅返回数字，如 750`,
      },
      {
        role: 'user',
        content: `用户掌握的单词: ${words.join(', ')}\n请评估其蓝斯值`,
      },
    ];

    const response = await axios.post(
      `${this.apiUrl}/chat/completions`,
      {
        model: this.model,
        messages,
        max_tokens: 10,
        temperature: 0.1,
      },
      {
        headers: {
          Authorization: `Bearer ${this.apiKey}`,
        },
      },
    );

    const lexile = parseInt(response.data.choices[0].message.content.trim());
    return isNaN(lexile) ? 750 : lexile;
  }
}
```

### 5. 费用估算

**DeepSeek 定价** (国内用户友好):

```
输入 token: ¥0.14/百万
输出 token: ¥0.28/百万

示例:
- 内容适配一本书 (10万字): ~¥2-3
- AI评估蓝斯值一次: ~¥0.01
- 月均成本 (1000本书): ~¥200-300
```

**与其他服务对比**:
- OpenAI GPT-4: ¥0.30/1K输入 tokens (更贵)
- Claude: ¥0.50/1M输入 tokens (需翻墙)
- DeepSeek: ¥0.14/1M输入 tokens (最便宜，国内可用)

---

## 阿里云 TTS 配置

### 1. 申请服务

**官网**: https://www.aliyun.com/

**步骤**:
1. 登录阿里云账号 (没有则注册)
2. 进入「智能语音交互」服务
3. 点击「开通服务」
4. 进入 API Key 管理
5. 创建新的「Access Key」

### 2. 获取凭证

**创建 Access Key**:
1. 在阿里云控制台，进入「访问控制」
2. 点击「创建 Access Key」
3. 保存 **Access Key ID** 和 **Access Key Secret**

### 3. 后端配置

**更新文件**: `backend/.env.local`

```env
# 阿里云 TTS 配置
ALIYUN_ACCESSKEY_ID=your_access_key_id
ALIYUN_ACCESSKEY_SECRET=your_access_key_secret
ALIYUN_TTS_REGION=cn-hangzhou
ALIYUN_TTS_ENDPOINT=nls-gateway-cn-shenzhen.aliyuncs.com
ALIYUN_TTS_VOICE=xiaoxiao  # 语音角色

# 腾讯云 TTS 备选配置
TENCENT_TTS_ENABLED=false
TENCENT_SECRET_ID=your_secret_id
TENCENT_SECRET_KEY=your_secret_key
```

### 4. 后端集成

```typescript
// src/services/tts.service.ts
import { Injectable } from '@nestjs/common';
import * as NLS from '@alicloud/nls-sdk';

@Injectable()
export class TtsService {
  private client: NLS.SpeechSynthesizer;

  constructor() {
    this.client = new NLS.SpeechSynthesizer({
      accessKeyId: process.env.ALIYUN_ACCESSKEY_ID,
      accessKeySecret: process.env.ALIYUN_ACCESSKEY_SECRET,
      appKey: process.env.ALIYUN_APP_KEY,
      region: process.env.ALIYUN_TTS_REGION,
    });
  }

  async synthesize(
    text: string,
    voice: string = 'xiaoxiao',
  ): Promise<Buffer> {
    try {
      const result = await this.client.synthesize({
        text,
        voice,
        format: 'mp3',
        sampleRate: 16000,
      });

      return result;
    } catch (error) {
      console.error('TTS synthesis error:', error);
      throw new Error('语音合成失败');
    }
  }

  async synthesizeChapter(
    chapterContent: string,
    chapterId: string,
  ): Promise<string> {
    // 返回生成的音频文件URL (上传到OSS)
    const audioBuffer = await this.synthesize(chapterContent);
    const uploadUrl = await this.uploadToOss(
      audioBuffer,
      `audio/chapter_${chapterId}.mp3`,
    );
    return uploadUrl;
  }

  private async uploadToOss(buffer: Buffer, key: string): Promise<string> {
    // 上传到阿里云 OSS
    // 返回公开 URL
    return `https://oss.example.com/${key}`;
  }
}
```

### 5. 支持的语音

```
小小 (xiaoxiao): 女声，温柔
大宝 (dabao): 男声，低沉
莎莎 (sasha): 女声，活泼
赵琳 (zhaolin): 女声，标准普通话
```

---

## 微信小程序配置

### 1. 注册微信公众平台账号

**官网**: https://mp.weixin.qq.com/

**流程**:
1. 访问微信公众平台
2. 点击「立即注册」
3. 选择「小程序」
4. 填写基本信息并验证
5. 获得 **AppID** 和 **AppSecret**

### 2. 小程序基本配置

**保存 AppID 和 AppSecret**:

```env
WECHAT_APPID=wx1234567890abcdef
WECHAT_APPSECRET=abcdef1234567890abcdef1234567890
```

### 3. 后端配置

**更新文件**: `backend/.env.local`

```env
# 微信小程序配置
WECHAT_APPID=wx1234567890abcdef
WECHAT_APPSECRET=abcdef1234567890abcdef1234567890
WECHAT_API_URL=https://api.weixin.qq.com

# 微信登录配置
WECHAT_LOGIN_ENABLED=true
WECHAT_OAUTH_CALLBACK=https://yourdomain.com/auth/wechat-callback
```

### 4. 微信认证配置

**配置服务器地址**:
1. 登录微信公众平台
2. 进入「设置 > 基本设置」
3. 找到「服务器地址」
4. 填入你的服务器地址: `https://yourdomain.com/api/wechat`
5. Token: 自定义 (如: `reading_app_token`)
6. EncodingAESKey: 自动生成

**更新后端**:

```env
WECHAT_VERIFY_TOKEN=reading_app_token
WECHAT_ENCODING_AES_KEY=your_encoding_aes_key
```

### 5. 前端配置

**更新文件**: `frontend/.env.development`

```env
TARO_APP_WECHAT_APPID=wx1234567890abcdef
TARO_APP_API_BASE=http://localhost:3000/api
```

### 6. 获取微信授权code

```typescript
// frontend/src/services/wechat.ts
import Taro from '@tarojs/taro';

export const getWechatAuthCode = async (): Promise<string> => {
  const res = await Taro.login();
  return res.code;  // 用于后端换取 access_token
};

export const getUserInfo = async () => {
  const res = await Taro.getUserInfo({
    withCredentials: true,
  });
  return {
    rawData: res.rawData,
    signature: res.signature,
    encryptedData: res.encryptedData,
    iv: res.iv,
  };
};
```

---

## 数据库配置

### 1. 本地 PostgreSQL 设置

**使用 Docker Compose**:

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: reading_postgres
    environment:
      POSTGRES_USER: reading_user
      POSTGRES_PASSWORD: secure_password_123
      POSTGRES_DB: reading_db
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U reading_user']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

**启动数据库**:

```bash
docker-compose up -d postgres
# 验证连接
psql -h localhost -U reading_user -d reading_db
```

### 2. Prisma 配置

**更新文件**: `backend/.env.local`

```env
# 数据库连接
DATABASE_URL=postgresql://reading_user:secure_password_123@localhost:5432/reading_db?schema=public
```

### 3. 数据库初始化

```bash
cd backend

# 生成 Prisma Client
npx prisma generate

# 创建初始迁移
npx prisma migrate dev --name init

# 填充示例数据 (可选)
npx ts-node scripts/seed.ts
```

### 4. 连接验证

```bash
# 使用 psql 连接
psql -h localhost -U reading_user -d reading_db

# 查看表
\dt

# 查看表结构
\d "User"
```

---

## Redis 配置

### 1. 本地 Redis 设置

**更新 docker-compose.yml**:

```yaml
services:
  redis:
    image: redis:7-alpine
    container_name: reading_redis
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  redis_data:
```

**启动 Redis**:

```bash
docker-compose up -d redis
# 验证
redis-cli ping
# 输出: PONG
```

### 2. 后端配置

**更新文件**: `backend/.env.local`

```env
# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=  # 本地开发可留空
REDIS_DB=0

# 缓存配置
CACHE_TTL=3600  # 1小时
CACHE_ENABLED=true
```

### 3. 缓存使用示例

```typescript
// src/services/cache.service.ts
import { Injectable } from '@nestjs/common';
import { RedisService } from '@liaoliaots/nestjs-redis';

@Injectable()
export class CacheService {
  constructor(private redis: RedisService) {}

  async set(
    key: string,
    value: any,
    ttl: number = 3600,
  ): Promise<void> {
    const client = this.redis.getClient();
    await client.setex(key, ttl, JSON.stringify(value));
  }

  async get<T>(key: string): Promise<T | null> {
    const client = this.redis.getClient();
    const value = await client.get(key);
    return value ? JSON.parse(value) : null;
  }

  async invalidate(pattern: string): Promise<void> {
    const client = this.redis.getClient();
    const keys = await client.keys(pattern);
    if (keys.length > 0) {
      await client.del(...keys);
    }
  }
}
```

---

## 生产环境配置

### 1. 阿里云 ECS 部署

**购买 ECS 实例**:
- 配置: 2核 4GB (入门) 或 4核 8GB (推荐)
- 系统: Ubuntu 20.04 LTS
- 地域: 选择离用户最近的地域

### 2. 环境变量设置

**在 ECS 上创建**: `/etc/environment`

```env
# 应用配置
NODE_ENV=production
PORT=3000

# 数据库
DATABASE_URL=postgresql://prod_user:secure_password@rds.aliyuncs.com:5432/reading_prod

# Redis
REDIS_HOST=redis.aliyuncs.com
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# DeepSeek
DEEPSEEK_API_KEY=sk_production_key

# 阿里云
ALIYUN_ACCESSKEY_ID=your_prod_access_key
ALIYUN_ACCESSKEY_SECRET=your_prod_secret

# 微信
WECHAT_APPID=wx_production_id
WECHAT_APPSECRET=wx_production_secret

# 日志
LOG_LEVEL=info
LOG_DIR=/var/log/reading-app
```

### 3. SSL/HTTPS 配置

**申请 SSL 证书** (阿里云):
1. 进入「SSL证书」服务
2. 申请免费证书或购买商业证书
3. 完成域名验证

**Nginx 配置**:

```nginx
# /etc/nginx/sites-available/reading-app

upstream reading_backend {
  server 127.0.0.1:3000;
}

server {
  listen 80;
  server_name yourdomain.com www.yourdomain.com;

  # 重定向到 HTTPS
  return 301 https://$server_name$request_uri;
}

server {
  listen 443 ssl http2;
  server_name yourdomain.com www.yourdomain.com;

  ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
  ssl_certificate_key /etc/ssl/private/yourdomain.com.key;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;

  location /api {
    proxy_pass http://reading_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location / {
    root /var/www/reading-app;
    index index.html;
    try_files $uri $uri/ /index.html;
  }
}
```

### 4. 自动备份配置

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/var/backups/reading-app"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
pg_dump reading_prod | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/data/reading-app/uploads

# 删除 30 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

---

## 故障排查

### 问题 1: DeepSeek API 连接失败

**错误日志**:
```
Error: connect ETIMEDOUT
```

**解决方案**:
1. 检查 API Key 是否正确
2. 检查网络连接 (国内用户可能需要特殊网络)
3. 检查 API URL 是否正确
4. 增加超时时间 (DEEPSEEK_TIMEOUT)

```bash
# 测试连接
curl -X POST https://api.deepseek.com/v1/chat/completions \
  -H "Authorization: Bearer your_api_key" \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"hello"}]}'
```

### 问题 2: 阿里云 TTS 返回错误

**错误**:
```
TtsServiceUnavailable: Service unavailable
```

**解决方案**:
1. 检查 Access Key 是否正确
2. 检查 Region 是否正确 (cn-hangzhou)
3. 检查服务是否开通
4. 使用腾讯云作为备选

### 问题 3: PostgreSQL 连接失败

**错误**:
```
FATAL: no password supplied
```

**解决方案**:
```bash
# 检查 DATABASE_URL 格式
echo $DATABASE_URL
# 应该是: postgresql://user:password@host:5432/database

# 测试连接
psql $DATABASE_URL -c "SELECT 1"
```

### 问题 4: Prisma 迁移失败

**错误**:
```
Migration failed, database is locked
```

**解决方案**:
```bash
# 重置迁移状态
npx prisma migrate resolve --rolled-back

# 检查迁移历史
npx prisma migrate status

# 重新应用迁移
npx prisma migrate dev
```

### 问题 5: 小程序无法连接后端

**错误**:
```
Request failed: Cannot reach server
```

**检查清单**:
- [ ] 后端服务是否运行中 (`curl http://localhost:3000/health`)
- [ ] 前端配置的 API_BASE 是否正确
- [ ] 微信小程序是否在合法域名列表中
- [ ] HTTPS 证书是否有效

**配置合法域名**:
1. 登录微信公众平台
2. 进入「开发 > 开发设置」
3. 在「服务器域名」中添加你的域名

---

## 验证清单

启动项目前，确保以下项目都已完成:

- [ ] Node.js 18+ 已安装
- [ ] DeepSeek API Key 已获取并配置
- [ ] 阿里云 Access Key 已获取并配置
- [ ] 微信 AppID/AppSecret 已获取并配置
- [ ] PostgreSQL 数据库已启动 (`docker-compose up -d`)
- [ ] Redis 已启动 (`redis-cli ping` 返回 PONG)
- [ ] `.env.local` 文件已完整配置
- [ ] Prisma 迁移已完成 (`npx prisma migrate dev`)
- [ ] 后端依赖已安装 (`npm install` in backend/)
- [ ] 前端依赖已安装 (`npm install` in frontend/)
- [ ] 所有配置的 API Key 都能访问 (无地区限制)

---

**维护者**: DevOps 团队
**最后更新**: 2025-10-25
