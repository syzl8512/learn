# å¬åŠ›å†…å®¹å¿«é€Ÿå¯¼å…¥å¤„ç†æŒ‡å—

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-10-25
**ç›®çš„**: æ”¯æŒ Excel/CSV æ‰¹é‡å¯¼å…¥å¬åŠ›å†…å®¹ï¼Œå¿«é€Ÿæ‰©å±•å†…å®¹åº“
**æ ¸å¿ƒæµç¨‹**: Excel ä¸Šä¼  â†’ éªŒè¯ â†’ éŸ³é¢‘å¤„ç† â†’ å…¥åº“ â†’ å‘å¸ƒ

---

## ğŸ“‹ ç›®å½•

1. [Excel æ¨¡æ¿è§„èŒƒ](#excel-æ¨¡æ¿è§„èŒƒ)
2. [åç«¯å¤„ç†æµç¨‹](#åç«¯å¤„ç†æµç¨‹)
3. [å®ç°ä»£ç ](#å®ç°ä»£ç )
4. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
5. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## Excel æ¨¡æ¿è§„èŒƒ

### åˆ—å®šä¹‰

```
Aåˆ—: è¯é¢˜ (Topic)
Båˆ—: éš¾åº¦ (Level)
Cåˆ—: æ ‡é¢˜ (Title)
Dåˆ—: æ—¶é•¿(ç§’) (Duration)
Eåˆ—: éŸ³é¢‘URL (AudioUrl)
Fåˆ—: æ–‡æœ¬å†…å®¹ (Transcript)
Gåˆ—: ä¸­æ–‡ç¿»è¯‘ (Translation)
Håˆ—: å†…å®¹ç±»å‹ (ContentType)
Iåˆ—: å…³é”®è¯æ±‡ (Keywords) - å¯é€‰
Jåˆ—: æ‘˜è¦ (Summary) - å¯é€‰
```

### ç¤ºä¾‹æ•°æ®

```
è¯é¢˜          | éš¾åº¦  | æ ‡é¢˜         | æ—¶é•¿(ç§’) | éŸ³é¢‘URL                   | æ–‡æœ¬å†…å®¹                  | ä¸­æ–‡ç¿»è¯‘           | å†…å®¹ç±»å‹   | å…³é”®è¯æ±‡            | æ‘˜è¦
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—¥å¸¸ç”Ÿæ´»      | åˆçº§ | æ—©ä¸Šçš„é—®å€™    | 120      | https://oss.../audio1.mp3 | Good morning...      | æ—©ä¸Šå¥½...      | dialogue | greeting,morning | ä¸¤ä¸ªäººæ—©ä¸Šæ‰“æ‹›å‘¼
æ—¥å¸¸ç”Ÿæ´»      | åˆçº§ | å’–å•¡åº—ç‚¹é¤    | 180      | https://oss.../audio2.mp3 | I would like...      | æˆ‘æƒ³è¦...      | dialogue | coffee,order     | é¡¾å®¢åœ¨å’–å•¡åº—ç‚¹é¤
ç§‘æŠ€åˆ›æ–°      | KET  | æ‰‹æœºå‘å±•å²    | 240      | https://oss.../audio3.mp3 | The smartphone...    | æ™ºèƒ½æ‰‹æœº...    | narrative| technology,phone | è®²è¿°æ‰‹æœºçš„å‘å±•å†å²
è‡ªç„¶ç§‘å­¦      | PET  | ç”Ÿæ€ç³»ç»Ÿ      | 300      | https://oss.../audio4.mp3 | An ecosystem is...    | ç”Ÿæ€ç³»ç»Ÿæ˜¯...  | narrative| ecosystem,nature | è®²è§£ç”Ÿæ€ç³»ç»Ÿçš„æ¦‚å¿µ
```

### æ•°æ®éªŒè¯è§„åˆ™

| åˆ— | å¿…å¡« | æœ‰æ•ˆå€¼ | ç¤ºä¾‹ |
|----|------|---------|------|
| è¯é¢˜ | æ˜¯ | æ—¥å¸¸ç”Ÿæ´»/ç§‘æŠ€åˆ›æ–°/å†å²æ–‡åŒ–/è‡ªç„¶ç§‘å­¦/ç¤¾ä¼šæ–‡åŒ–/å“²å­¦æ€è¾¨ | æ—¥å¸¸ç”Ÿæ´» |
| éš¾åº¦ | æ˜¯ | åˆçº§/KET/PET | KET |
| æ ‡é¢˜ | æ˜¯ | ä»»æ„å­—ç¬¦ä¸²ï¼Œé•¿åº¦ 1-200 | æ—©ä¸Šçš„é—®å€™ |
| æ—¶é•¿ | å¦ | 1-3600 (ç§’) | 120 |
| éŸ³é¢‘URL | æ˜¯ | æœ‰æ•ˆçš„ HTTP/HTTPS URL | https://... |
| æ–‡æœ¬å†…å®¹ | æ˜¯ | è‹±æ–‡æ–‡æœ¬ï¼Œé•¿åº¦ > 20 å­—ç¬¦ | Good morning... |
| ä¸­æ–‡ç¿»è¯‘ | æ˜¯ | ä¸­æ–‡æ–‡æœ¬ï¼Œé•¿åº¦ > 10 å­—ç¬¦ | æ—©ä¸Šå¥½... |
| å†…å®¹ç±»å‹ | å¦ | dialogue/narrative/discussion/interview | dialogue |
| å…³é”®è¯æ±‡ | å¦ | é€—å·åˆ†éš”çš„è¯æ±‡ | greeting,morning |
| æ‘˜è¦ | å¦ | ä¸­æ–‡æ‘˜è¦æ–‡æœ¬ | ä¸¤ä¸ªäººæ—©ä¸Šæ‰“æ‹›å‘¼ |

---

## åç«¯å¤„ç†æµç¨‹

### æ•´ä½“æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼  Excel  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æ Excel æ–‡ä»¶  â”‚ â† ä½¿ç”¨ xlsx åº“è§£æ
â”‚ (é€è¡Œè¯»å–æ•°æ®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é€è¡ŒéªŒè¯æ•°æ®   â”‚ â† å­—æ®µæ£€æŸ¥ã€æ ¼å¼æ ¡éªŒ
â”‚ (ç”Ÿæˆé”™è¯¯æŠ¥å‘Š)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ æœ‰é”™è¯¯ï¼Ÿ â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    æ˜¯     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚è¿”å›é”™è¯¯ä¿¡æ¯      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚åœæ­¢å¯¼å…¥          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚    å¦     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‹è½½éŸ³é¢‘æ–‡ä»¶    â”‚ â† éªŒè¯ URL æœ‰æ•ˆæ€§
â”‚ (è‡³æœ¬åœ°ä¸´æ—¶ç›®å½•) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éŸ³é¢‘å¤„ç†        â”‚ â† è½¬ç ã€æå–ä¿¡æ¯
â”‚ (ç”Ÿæˆæ ‡å‡†æ ¼å¼)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šä¼ è‡³ OSS      â”‚ â† è·å–æ°¸ä¹… URL
â”‚ (æ›¿æ¢éŸ³é¢‘URL)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®å…¥åº“        â”‚ â† æ‰¹é‡æ’å…¥æ•°æ®åº“
â”‚ (äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆåŠŸå®Œæˆ        â”‚
â”‚ (è¿”å›å¯¼å…¥ç»Ÿè®¡)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤„ç†æ­¥éª¤è¯¦è§£

**Step 1: è§£æ Excel**
- ä½¿ç”¨ `xlsx` åº“è¯»å–æ–‡ä»¶
- æ ¡éªŒåˆ—æ ‡é¢˜æ˜¯å¦ç¬¦åˆè§„èŒƒ
- é€è¡Œè¯»å–æ•°æ®

**Step 2: æ•°æ®éªŒè¯**
- å¿…å¡«å­—æ®µæ£€æŸ¥
- æ•°æ®ç±»å‹è½¬æ¢ (å¦‚ Duration è½¬ number)
- æ ¼å¼æ ¡éªŒ (å¦‚ URL æ ¼å¼ã€è“æ–¯å€¼èŒƒå›´)
- ç”Ÿæˆè¯¦ç»†é”™è¯¯æŠ¥å‘Š

**Step 3: éŸ³é¢‘å¤„ç†**
- éªŒè¯éŸ³é¢‘ URL å¯è¾¾æ€§
- ä¸‹è½½éŸ³é¢‘æ–‡ä»¶è‡³ä¸´æ—¶ç›®å½•
- ä½¿ç”¨ FFmpeg è½¬ç ä¸ºæ ‡å‡†æ ¼å¼ (mp3, 48kHz)
- ç”ŸæˆéŸ³é¢‘å…ƒæ•°æ® (æ—¶é•¿ã€å­—èŠ‚æ•°ç­‰)

**Step 4: ä¸Šä¼ è‡³ OSS**
- ä¸Šä¼ å¤„ç†åçš„éŸ³é¢‘è‡³é˜¿é‡Œäº‘ OSS
- è·å–å…¬å¼€ URL (é•¿æœŸæœ‰æ•ˆ)
- æ›¿æ¢åŸ URL

**Step 5: æ•°æ®å…¥åº“**
- äº‹åŠ¡å¼€å¯
- æ‰¹é‡æ’å…¥ ListeningContent è¡¨
- æ’å…¥ç›¸å…³å­è¡¨æ•°æ®
- äº‹åŠ¡æäº¤

---

## å®ç°ä»£ç 

### 1. ä¸Šä¼ æ¥å£å®šä¹‰

**controller/listening.controller.ts**:

```typescript
import {
  Controller,
  Post,
  UseInterceptors,
  UploadedFile,
  BadRequestException,
  Req,
  Query,
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { Request } from 'express';
import { ListeningService } from '../services/listening.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { UseGuards } from '@nestjs/common';

@Controller('api/listening')
export class ListeningController {
  constructor(private listeningService: ListeningService) {}

  @Post('batch-import')
  @UseGuards(JwtAuthGuard)
  @UseInterceptors(FileInterceptor('file'))
  async batchImport(
    @UploadedFile() file: Express.Multer.File,
    @Req() req: Request,
    @Query('skipValidation') skipValidation: boolean = false,
  ) {
    if (!file) {
      throw new BadRequestException('è¯·é€‰æ‹© Excel æˆ– CSV æ–‡ä»¶');
    }

    // éªŒè¯æ–‡ä»¶ç±»å‹
    const allowedMimes = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-excel',
      'text/csv',
    ];

    if (!allowedMimes.includes(file.mimetype)) {
      throw new BadRequestException(
        'ä»…æ”¯æŒ Excel (.xlsx, .xls) æˆ– CSV æ–‡ä»¶',
      );
    }

    // éªŒè¯æ–‡ä»¶å¤§å° (æœ€å¤š 10MB)
    if (file.size > 10 * 1024 * 1024) {
      throw new BadRequestException('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
    }

    const userId = req.user.id;

    // å¯åŠ¨å¼‚æ­¥å¯¼å…¥
    const importId = await this.listeningService.startBatchImport(
      file.buffer,
      userId,
      skipValidation,
    );

    return {
      code: 0,
      data: {
        importId,
        status: 'processing',
        message: 'æ­£åœ¨å¤„ç†ï¼Œé¢„è®¡ 2-5 åˆ†é’Ÿå®Œæˆ',
        progressUrl: `/api/listening/batch-import/${importId}/progress`,
      },
    };
  }

  @Get('batch-import/:importId/progress')
  @UseGuards(JwtAuthGuard)
  async getImportProgress(@Param('importId') importId: string) {
    const progress = await this.listeningService.getImportProgress(importId);
    return {
      code: 0,
      data: progress,
    };
  }
}
```

### 2. æ ¸å¿ƒæœåŠ¡

**services/listening.service.ts**:

```typescript
import { Injectable, BadRequestException } from '@nestjs/common';
import { PrismaService } from '../database/prisma.service';
import * as xlsx from 'xlsx';
import * as fs from 'fs';
import * as path from 'path';
import axios from 'axios';
import { execSync } from 'child_process';

interface ListeningRow {
  topic: string;
  level: string;
  title: string;
  duration?: number;
  audioUrl: string;
  transcript: string;
  translation: string;
  contentType?: string;
  keywords?: string;
  summary?: string;
}

interface ValidationError {
  rowNumber: number;
  error: string;
  title?: string;
}

interface ImportProgress {
  importId: string;
  status: 'processing' | 'completed' | 'failed';
  totalRows: number;
  successCount: number;
  failureCount: number;
  pendingCount: number;
  progress: number;
  errors: ValidationError[];
  completedAt?: Date;
}

@Injectable()
export class ListeningService {
  private importProgress: Map<string, ImportProgress> = new Map();
  private tempDir = path.join(process.cwd(), 'temp', 'listening');

  constructor(private prisma: PrismaService) {
    // ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
    if (!fs.existsSync(this.tempDir)) {
      fs.mkdirSync(this.tempDir, { recursive: true });
    }
  }

  async startBatchImport(
    fileBuffer: Buffer,
    userId: string,
    skipValidation: boolean = false,
  ): Promise<string> {
    const importId = `import_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    // åˆå§‹åŒ–è¿›åº¦è·Ÿè¸ª
    this.importProgress.set(importId, {
      importId,
      status: 'processing',
      totalRows: 0,
      successCount: 0,
      failureCount: 0,
      pendingCount: 0,
      progress: 0,
      errors: [],
    });

    // å¼‚æ­¥æ‰§è¡Œå¯¼å…¥
    this.processBatchImportAsync(fileBuffer, importId, userId, skipValidation);

    return importId;
  }

  private async processBatchImportAsync(
    fileBuffer: Buffer,
    importId: string,
    userId: string,
    skipValidation: boolean,
  ) {
    try {
      // 1. è§£æ Excel
      const rows = this.parseExcel(fileBuffer);

      const progress = this.importProgress.get(importId);
      if (progress) {
        progress.totalRows = rows.length;
        progress.pendingCount = rows.length;
      }

      // 2. éªŒè¯æ•°æ®
      const validationErrors = this.validateRows(rows);

      // å¦‚æœæœ‰é”™è¯¯ä¸”ä¸è·³è¿‡éªŒè¯ï¼Œåœæ­¢å¯¼å…¥
      if (validationErrors.length > 0 && !skipValidation) {
        if (progress) {
          progress.status = 'failed';
          progress.errors = validationErrors;
          progress.failureCount = validationErrors.length;
          progress.pendingCount = 0;
          progress.completedAt = new Date();
        }
        return;
      }

      // 3. å¤„ç†éŸ³é¢‘
      const processedRows = await this.processAudioFiles(
        rows,
        importId,
        progress,
      );

      // 4. æ•°æ®å…¥åº“
      const insertedCount = await this.insertListeningContent(
        processedRows,
        userId,
        importId,
      );

      // 5. æ›´æ–°è¿›åº¦
      if (progress) {
        progress.status = 'completed';
        progress.successCount = insertedCount;
        progress.pendingCount = 0;
        progress.progress = 100;
        progress.completedAt = new Date();
      }
    } catch (error) {
      const progress = this.importProgress.get(importId);
      if (progress) {
        progress.status = 'failed';
        progress.errors = [
          {
            rowNumber: 0,
            error: error.message || 'æœªçŸ¥é”™è¯¯',
          },
        ];
        progress.completedAt = new Date();
      }
      console.error(`Import ${importId} failed:`, error);
    }
  }

  private parseExcel(fileBuffer: Buffer): ListeningRow[] {
    try {
      const workbook = xlsx.read(fileBuffer, { type: 'buffer' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];

      // è·å–æ‰€æœ‰è¡Œ
      const rows: ListeningRow[] = [];
      let rowIndex = 2; // ä»ç¬¬ 2 è¡Œå¼€å§‹ (è·³è¿‡æ ‡é¢˜)

      while (true) {
        const cellA = worksheet[`A${rowIndex}`];
        if (!cellA) break; // åˆ°è¾¾ç©ºè¡Œï¼Œåœæ­¢

        rows.push({
          topic: cellA.v || '',
          level: worksheet[`B${rowIndex}`]?.v || '',
          title: worksheet[`C${rowIndex}`]?.v || '',
          duration: parseInt(worksheet[`D${rowIndex}`]?.v) || undefined,
          audioUrl: worksheet[`E${rowIndex}`]?.v || '',
          transcript: worksheet[`F${rowIndex}`]?.v || '',
          translation: worksheet[`G${rowIndex}`]?.v || '',
          contentType: worksheet[`H${rowIndex}`]?.v || 'narrative',
          keywords: worksheet[`I${rowIndex}`]?.v || '',
          summary: worksheet[`J${rowIndex}`]?.v || '',
        });

        rowIndex++;
      }

      return rows;
    } catch (error) {
      throw new BadRequestException('Excel æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message);
    }
  }

  private validateRows(rows: ListeningRow[]): ValidationError[] {
    const errors: ValidationError[] = [];

    const validTopics = [
      'æ—¥å¸¸ç”Ÿæ´»',
      'ç§‘æŠ€åˆ›æ–°',
      'å†å²æ–‡åŒ–',
      'è‡ªç„¶ç§‘å­¦',
      'ç¤¾ä¼šæ–‡åŒ–',
      'å“²å­¦æ€è¾¨',
    ];
    const validLevels = ['åˆçº§', 'KET', 'PET'];

    rows.forEach((row, idx) => {
      const rowNumber = idx + 2; // Excel ä¸­çš„è¡Œå·

      // éªŒè¯è¯é¢˜
      if (!validTopics.includes(row.topic)) {
        errors.push({
          rowNumber,
          error: `æ— æ•ˆçš„è¯é¢˜: ${row.topic}ï¼Œåº”ä¸º: ${validTopics.join('/')}`,
          title: row.title,
        });
      }

      // éªŒè¯éš¾åº¦
      if (!validLevels.includes(row.level)) {
        errors.push({
          rowNumber,
          error: `æ— æ•ˆçš„éš¾åº¦: ${row.level}ï¼Œåº”ä¸º: ${validLevels.join('/')}`,
          title: row.title,
        });
      }

      // éªŒè¯æ ‡é¢˜
      if (!row.title || row.title.trim().length === 0) {
        errors.push({
          rowNumber,
          error: 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º',
          title: row.title,
        });
      }

      // éªŒè¯éŸ³é¢‘ URL
      if (!row.audioUrl || !this.isValidUrl(row.audioUrl)) {
        errors.push({
          rowNumber,
          error: 'æ— æ•ˆçš„éŸ³é¢‘ URL',
          title: row.title,
        });
      }

      // éªŒè¯æ–‡æœ¬å†…å®¹
      if (!row.transcript || row.transcript.trim().length < 20) {
        errors.push({
          rowNumber,
          error: 'æ–‡æœ¬å†…å®¹é•¿åº¦è‡³å°‘ 20 å­—ç¬¦',
          title: row.title,
        });
      }

      // éªŒè¯ç¿»è¯‘
      if (!row.translation || row.translation.trim().length < 10) {
        errors.push({
          rowNumber,
          error: 'ä¸­æ–‡ç¿»è¯‘é•¿åº¦è‡³å°‘ 10 å­—ç¬¦',
          title: row.title,
        });
      }
    });

    return errors;
  }

  private async processAudioFiles(
    rows: ListeningRow[],
    importId: string,
    progress: ImportProgress | undefined,
  ): Promise<ListeningRow[]> {
    const processedRows: ListeningRow[] = [];

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      try {
        // ä¸‹è½½éŸ³é¢‘
        const audioPath = await this.downloadAudio(row.audioUrl, importId, i);

        // è½¬ç ä¸ºæ ‡å‡†æ ¼å¼
        const processedAudioPath = await this.transcodeAudio(
          audioPath,
          importId,
          i,
        );

        // ä¸Šä¼ è‡³ OSS
        const ossUrl = await this.uploadToOss(
          processedAudioPath,
          `listening/${importId}/audio_${i}.mp3`,
        );

        // æ›¿æ¢ URL
        row.audioUrl = ossUrl;

        // è·å–éŸ³é¢‘æ—¶é•¿ (å¦‚æœæœªæä¾›)
        if (!row.duration) {
          row.duration = await this.getAudioDuration(processedAudioPath);
        }

        processedRows.push(row);

        // æ›´æ–°è¿›åº¦
        if (progress) {
          progress.successCount++;
          progress.pendingCount--;
          progress.progress = Math.round(
            (progress.successCount / progress.totalRows) * 100,
          );
        }
      } catch (error) {
        console.error(`Failed to process audio for row ${i + 2}:`, error);
        // ç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
      }
    }

    return processedRows;
  }

  private async downloadAudio(
    url: string,
    importId: string,
    index: number,
  ): Promise<string> {
    const filename = `audio_${index}_${Date.now()}.tmp`;
    const filepath = path.join(this.tempDir, importId, filename);

    // ç¡®ä¿ç›®å½•å­˜åœ¨
    fs.mkdirSync(path.dirname(filepath), { recursive: true });

    try {
      const response = await axios.get(url, {
        responseType: 'arraybuffer',
        timeout: 30000,
      });

      fs.writeFileSync(filepath, response.data);
      return filepath;
    } catch (error) {
      throw new Error(`ä¸‹è½½éŸ³é¢‘å¤±è´¥: ${error.message}`);
    }
  }

  private async transcodeAudio(
    inputPath: string,
    importId: string,
    index: number,
  ): Promise<string> {
    const outputPath = path.join(
      this.tempDir,
      importId,
      `audio_${index}_processed.mp3`,
    );

    try {
      // ä½¿ç”¨ FFmpeg è½¬ç 
      execSync(
        `ffmpeg -i "${inputPath}" -acodec libmp3lame -ab 128k -ar 48000 "${outputPath}"`,
        { stdio: 'pipe' },
      );

      // åˆ é™¤åŸå§‹æ–‡ä»¶
      fs.unlinkSync(inputPath);

      return outputPath;
    } catch (error) {
      throw new Error(`éŸ³é¢‘è½¬ç å¤±è´¥: ${error.message}`);
    }
  }

  private async getAudioDuration(audioPath: string): Promise<number> {
    try {
      const output = execSync(
        `ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1:noval=0 "${audioPath}"`,
        { encoding: 'utf-8' },
      );

      return Math.round(parseFloat(output.trim()));
    } catch (error) {
      console.error('Failed to get audio duration:', error);
      return 0;
    }
  }

  private async uploadToOss(
    localPath: string,
    objectKey: string,
  ): Promise<string> {
    // ä½¿ç”¨é˜¿é‡Œäº‘ OSS SDK ä¸Šä¼ 
    // è¿”å›æ°¸ä¹… URL
    // TODO: å®ç° OSS ä¸Šä¼ 
    return `https://oss.example.com/${objectKey}`;
  }

  private async insertListeningContent(
    rows: ListeningRow[],
    userId: string,
    importId: string,
  ): Promise<number> {
    // ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    const created = await this.prisma.$transaction(
      rows.map((row) =>
        this.prisma.listeningContent.create({
          data: {
            title: row.title,
            topic: row.topic,
            level: row.level,
            duration: row.duration,
            audioUrl: row.audioUrl,
            transcript: row.transcript,
            translation: row.translation,
            contentType: row.contentType || 'narrative',
            keywords: row.keywords,
            summary: row.summary,
            importBatchId: importId,
            importedBy: userId,
            importedAt: new Date(),
          },
        }),
      ),
    );

    return created.length;
  }

  private isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return url.startsWith('http://') || url.startsWith('https://');
    } catch {
      return false;
    }
  }

  getImportProgress(importId: string): ImportProgress {
    return (
      this.importProgress.get(importId) || {
        importId,
        status: 'failed',
        totalRows: 0,
        successCount: 0,
        failureCount: 0,
        pendingCount: 0,
        progress: 0,
        errors: [{ rowNumber: 0, error: 'å¯¼å…¥ä¸å­˜åœ¨' }],
      }
    );
  }
}
```

### 3. æ•°æ®åº“æ¨¡å‹æ›´æ–°

**schema.prisma**:

```prisma
model ListeningContent {
  id              String @id @default(cuid())
  title           String
  topic           String  // æ—¥å¸¸ç”Ÿæ´»|ç§‘æŠ€åˆ›æ–°|å†å²æ–‡åŒ–|è‡ªç„¶ç§‘å­¦|ç¤¾ä¼šæ–‡åŒ–|å“²å­¦æ€è¾¨
  level           String  // åˆçº§|KET|PET
  duration        Int?    // ç§’æ•°
  audioUrl        String
  transcript      String  @db.Text
  translation     String  @db.Text
  contentType     String  @default("narrative")  // dialogue|narrative|discussion|interview
  keywords        String? // é€—å·åˆ†éš”
  summary         String? @db.Text

  // å¯¼å…¥å…ƒæ•°æ®
  importBatchId   String?
  importedAt      DateTime?
  importedBy      String?

  // å…³è”
  listeningHistory ListeningHistory[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([topic])
  @@index([level])
  @@index([importBatchId])
}

model ListeningHistory {
  id                String @id @default(cuid())
  userId            String
  listeningContentId String
  listeningContent  ListeningContent @relation(fields: [listeningContentId], references: [id], onDelete: Cascade)

  listenCount       Int @default(1)
  totalListeningTime Int @default(0)  // ç§’æ•°
  completed         Boolean @default(false)
  completedAt       DateTime?
  lastListenAt      DateTime @default(now())

  playbackSpeed     Float @default(1.0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, listeningContentId])
  @@index([userId])
}
```

---

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åœºæ™¯

| åœºæ™¯ | é”™è¯¯ä¿¡æ¯ | å¤„ç†æ–¹æ¡ˆ |
|------|--------|--------|
| æ–‡ä»¶æ ¼å¼é”™è¯¯ | "ä»…æ”¯æŒ Excel æˆ– CSV æ–‡ä»¶" | æ£€æŸ¥æ–‡ä»¶ç±»å‹ |
| æ–‡ä»¶å¤ªå¤§ | "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB" | åˆ†æ‰¹ä¸Šä¼  |
| Excel æ ¼å¼é”™è¯¯ | "Excel æ–‡ä»¶æ ¼å¼é”™è¯¯" | æ£€æŸ¥åˆ—æ ‡é¢˜å’Œæ•°æ®æ ¼å¼ |
| è¯é¢˜æ— æ•ˆ | "æ— æ•ˆçš„è¯é¢˜: xxx" | ä½¿ç”¨è§„å®šçš„ 6 ä¸ªè¯é¢˜ |
| URL æ— æ•ˆ | "æ— æ•ˆçš„éŸ³é¢‘ URL" | æ£€æŸ¥ URL å¯è¾¾æ€§ |
| ä¸‹è½½å¤±è´¥ | "ä¸‹è½½éŸ³é¢‘å¤±è´¥: xxx" | æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ URL |
| è½¬ç å¤±è´¥ | "éŸ³é¢‘è½¬ç å¤±è´¥: xxx" | ç¡®ä¿å·²å®‰è£… FFmpeg |
| OSS ä¸Šä¼ å¤±è´¥ | "OSS ä¸Šä¼ å¤±è´¥: xxx" | æ£€æŸ¥ Access Key é…ç½® |

### å®¢æˆ·ç«¯é”™è¯¯å¤„ç†

```typescript
// frontend/src/services/listening.ts

export const batchImportListening = async (file: File) => {
  try {
    const formData = new FormData();
    formData.append('file', file);

    const response = await axios.post(
      '/api/listening/batch-import',
      formData,
      {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      },
    );

    const importId = response.data.data.importId;

    // å¼€å§‹è½®è¯¢è¿›åº¦
    return pollImportProgress(importId);
  } catch (error) {
    if (error.response?.status === 400) {
      throw new Error(error.response.data.message);
    }
    throw new Error('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

// è½®è¯¢å¯¼å…¥è¿›åº¦
const pollImportProgress = async (importId: string) => {
  return new Promise((resolve, reject) => {
    const interval = setInterval(async () => {
      try {
        const response = await axios.get(
          `/api/listening/batch-import/${importId}/progress`,
        );
        const progress = response.data.data;

        if (progress.status === 'completed') {
          clearInterval(interval);
          resolve({
            success: true,
            successCount: progress.successCount,
            errorCount: progress.failureCount,
            errors: progress.errors,
          });
        } else if (progress.status === 'failed') {
          clearInterval(interval);
          reject(new Error(progress.errors[0]?.error || 'å¯¼å…¥å¤±è´¥'));
        }
      } catch (error) {
        clearInterval(interval);
        reject(error);
      }
    }, 2000); // æ¯ 2 ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›åº¦
  });
};
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡å¤„ç†

```typescript
// æ‰¹é‡æ’å…¥ï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”
const created = await this.prisma.$transaction(
  rows.map((row) =>
    this.prisma.listeningContent.create({ data: row }),
  ),
);
```

### 2. å¹¶å‘å¤„ç†éŸ³é¢‘

```typescript
// ä½¿ç”¨ Promise.all å¹¶å‘å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸²è¡Œ
const processAudioPromises = rows.map((row, idx) =>
  this.processAudioFile(row, importId, idx),
);

const results = await Promise.all(processAudioPromises);
```

### 3. æµå¼å¤„ç†å¤§æ–‡ä»¶

```typescript
// å¯¹äºå¤§ Excel æ–‡ä»¶ï¼Œä½¿ç”¨æµå¼å¤„ç†
import { createReadStream } from 'fs';

const workbook = xlsx.read(fileBuffer, {
  type: 'buffer',
  sheetStubs: false,
});
```

### 4. éŸ³é¢‘é¢„å¤„ç†ç¼“å­˜

```typescript
// ç¼“å­˜å·²è½¬ç çš„éŸ³é¢‘ï¼Œé¿å…é‡å¤å¤„ç†
const audioCache = new Map<string, string>();

if (audioCache.has(audioUrl)) {
  row.audioUrl = audioCache.get(audioUrl);
} else {
  const processedUrl = await this.processAudio(audioUrl);
  audioCache.set(audioUrl, processedUrl);
  row.audioUrl = processedUrl;
}
```

---

**ç»´æŠ¤è€…**: åç«¯å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-10-25
