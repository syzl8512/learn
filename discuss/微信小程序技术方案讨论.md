# 微信小程序技术方案讨论稿

**文档状态**: 讨论稿（等待确认）
**创建日期**: 2025-10-25
**相关需求**: 项目最终部署在微信小程序上使用

---

## 核心问题

基于项目需求文档的技术栈：
- 后端: NestJS + Prisma + PostgreSQL ✅（保持不变）
- 前端: React 18 + TypeScript + Vite + Zustand + Ant Design + Tailwind ⚠️（需要调整）

**新增约束**: 最终产品将在 **微信小程序** 上使用

---

## 核心选择：Taro 4.x

### 方案概述

使用 **Taro 4.x**（字节跳动开源框架）进行前端开发：

```
一份 React 代码 → 编译到多个平台
  ├─ 微信小程序 (weapp) [PRIMARY]
  ├─ H5 网页版 (h5) [备用]
  └─ 支付宝小程序、快手等 [未来扩展]
```

### 为什么选 Taro？

| 维度 | Taro | 原方案(纯 React) |
|------|------|--------|
| **小程序支持** | ✅ 原生编译 | ❌ 无法编译 |
| **代码复用** | 95% 代码共享 | 0% 需要重写 |
| **React 一致性** | React 19 + TypeScript | React 19 + TypeScript |
| **学习成本** | 低（React 开发者友好） | 需学原生小程序 |
| **社区活跃度** | 3.5K+ Star | 不适用 |
| **包体积** | 可控（分包支持） | N/A |
| **开发体验** | 一套代码多平台热更新 | 分离开发维护成本高 |

### 对标方案分析

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **Taro 4.x** | 代码复用高、React 生态、字节背书、小程序原生支持 | 文档略少于 React | ⭐⭐⭐⭐⭐ |
| **uni-app** | Vue 生态成熟 | 与项目 React 栈不一致 | ⭐⭐⭐ |
| **React Native + Web 分离** | 各平台优化 | 代码重复、维护成本高 | ⭐⭐ |
| **原生小程序 + Web 分离** | 原生最优 | 几乎没有代码复用 | ⭐ |

---

## 技术栈调整方案

### 前端（重新设计）

#### 核心技术选项

```
框架:         Taro 4.x
语言:         TypeScript 5.3+
基础库:       React 19
状态管理:     Zustand（保持一致）
HTTP 客户端:  Taro 网络 API + axios（跨平台适配）
样式方案:     NativeWind / CSS Modules
包管理器:     npm / pnpm
```

#### 编译目标

**小程序版（PRIMARY）**:
```bash
npm run dev:weapp    # 开发调试（微信开发者工具打开 dist/weapp）
npm run build:weapp  # 生产构建
```

**H5 网页版（备用/PC 管理）**:
```bash
npm run dev:h5       # 开发服务器
npm run build:h5     # 生产构建
```

#### 项目结构（与 CLAUDE.md 保持一致）

```
frontend/
├── src/
│   ├── pages/              # Taro 页面组件（.tsx）
│   │   ├── index/         # 首页/书籍列表
│   │   ├── reading/       # 阅读页（核心）
│   │   ├── vocabulary/    # 生词表
│   │   ├── bookmarks/     # 书签
│   │   ├── login/         # 登录页
│   │   └── ...
│   ├── components/         # 通用组件
│   ├── services/           # API 调用
│   ├── stores/             # Zustand stores
│   ├── config/
│   ├── app.tsx             # 根组件
│   └── index.tsx           # 入口
├── project.config.json     # Taro 配置（重要）
├── package.json
├── tsconfig.json
└── dist/
    ├── weapp/              # 小程序编译产物
    └── h5/                 # H5 编译产物
```

---

## 认证与登录适配

### 微信小程序登录流程（已在 CLAUDE.md 详述）

```
用户点击"微信登录" → wx.login() → code → 后端验证 → JWT token
  ↓
保存 token（Taro.setStorageSync）→ 后续请求自动添加 Authorization header
```

### 后端改动（最小化）

```typescript
// backend/src/modules/auth/auth.service.ts

@Injectable()
export class AuthService {

  // 新增：微信登录
  async wechatLogin(code: string) {
    // 1. 用 code 向微信服务器验证
    const { openid, session_key } = await this.verifyWithWeChat(code);

    // 2. 创建或更新用户
    let user = await this.prisma.user.findUnique({ where: { openid } });
    if (!user) {
      user = await this.prisma.user.create({
        data: { openid, nickname: '新用户' }
      });
    }

    // 3. 生成 JWT token
    const token = this.jwtService.sign({ sub: user.id, openid });

    return { token, user };
  }

  // 已有：JWT 验证
  validateToken(token: string) { /* ... */ }
}
```

### 环境变量新增项

```env
WECHAT_APP_ID=wx_xxxxx           # 微信小程序 AppID
WECHAT_APP_SECRET=xxxxx          # 微信小程序 AppSecret
WECHAT_GRANT_TYPE=authorization_code
```

**如何获取**:
1. 在 微信公众平台 登录小程序账号
2. 进入 "设置 → 开发设置"
3. 复制 AppID 和 AppSecret

---

## 前后端交互（无需改动）

### 已有 API 兼容性

前端 (Taro) 使用 HTTP 调用后端 (NestJS) 的所有 API：

```typescript
// frontend/src/services/api.ts
import axios from 'axios';
import Taro from '@tarojs/taro';

const httpClient = axios.create({
  baseURL: process.env.TARO_APP_API_BASE || 'http://localhost:3000/api',
  timeout: 10000,
});

// 自动添加 JWT
httpClient.interceptors.request.use((config) => {
  const token = Taro.getStorageSync('jwt_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

export default httpClient;
```

**后端无需改动**（只需添加微信登录端点）

---

## 关键风险与应对

### 1. 微信小程序限制

| 限制 | 影响 | 应对方案 |
|------|------|--------|
| **主包体积 2MB** | 代码分包、精减依赖 | Taro 自动分包；选择轻量级库 |
| **分包最大 20MB** | 分包数量有限（5个） | 合理规划分包策略 |
| **网络请求限制** | 发送请求需 https + 域名白名单 | 后端部署 https；在微信后台配置服务器域名 |
| **本地存储限制 10MB** | 缓存策略 | 只缓存必要数据 |
| **无法访问文件系统** | 文件上传受限 | 使用微信提供的 API（wx.chooseImage 等） |

### 2. Taro 与第三方库兼容性

**可能的问题**:
- 某些 npm 包不支持小程序（如 DOM 操作库）
- 需要提前测试核心依赖

**应对**:
- 使用 Taro 官方推荐的库（axios 可用）
- 对不兼容的包进行 Taro 插件适配或替换

### 3. 微信登录申请周期

**前置条件**:
- 需要微信公众平台账号
- 小程序审核需 1-3 天
- **建议**: 现在就申请小程序账号（获取 AppID），开发阶段用测试 ID

---

## 迭代与交付计划（无需改动）

### Phase 1: 基础功能（4 周）
- [x] 后端框架 + 数据库（NestJS + Prisma）
- [ ] 微信登录集成（后端 + 前端）
- [ ] Taro 项目初始化
- [ ] 书籍/章节 CRUD API + 前端页面
- [ ] MinerU PDF 集成

### Phase 2-4: 继续原计划
- AI 适配、词义翻译、UI 优化、部署

---

## 后端改动清单（最小化）

### 1. 新增端点

```
POST /auth/wechat/login
  请求: { code: string }
  响应: { token: string; user: { id, nickname, avatar } }
```

### 2. 修改 User 模型（Prisma）

```prisma
model User {
  id       String @id @default(cuid())
  openid   String @unique      // 新增：微信 openid
  nickname String?
  avatar   String?
  ...
}
```

### 3. 后端依赖（可能新增）

```
axios          # 调用微信 API（可选，已有）
```

**预计代码量**: ~200 行（auth.service.ts + controller）

---

## 前端改动清单（完整重构）

### 1. 初始化 Taro 项目

```bash
# 使用脚手架
npx @tarojs/cli@latest init frontend --typescript --react

# 或手动配置 project.config.json
```

### 2. 核心依赖安装

```json
{
  "dependencies": {
    "@tarojs/react": "4.x",
    "@tarojs/taro": "4.x",
    "zustand": "^4.4",
    "axios": "^1.6",
    "classnames": "^2.3"
  },
  "devDependencies": {
    "@tarojs/cli": "4.x",
    "typescript": "^5.3",
    "@types/react": "^18.2"
  }
}
```

### 3. 文件迁移与改写

| 功能 | 文件 | 状态 |
|------|------|------|
| 微信登录页面 | `src/pages/login/index.tsx` | 新建 |
| 书籍列表页面 | `src/pages/index/index.tsx` | 新建（Taro 版） |
| 阅读页面 | `src/pages/reading/index.tsx` | 新建（核心） |
| API 客户端 | `src/services/api.ts` | 改写（Taro 网络 API 适配） |
| Zustand stores | `src/stores/*.ts` | 迁移（基本无改动） |
| 词义弹窗 | `src/components/DictionaryPopup.tsx` | 改写（Taro 组件） |

**预计代码量**: ~2000-3000 行（新建）

---

## 开发工具准备

### 本地环境

```bash
# Node.js 18+
node --version     # v18.0.0+

# npm/pnpm
npm --version      # 9+

# Git
git --version
```

### 微信开发者工具

1. 下载: https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 扫码登录
3. 新建项目 → 选择 `frontend/dist/weapp` 目录
4. 填入 AppID（申请小程序后获取）

### VS Code 扩展（可选）

- Taro 官方扩展（代码提示）
- Weapp Snippets（小程序片段）

---

## 需要你确认的问题

### Q1: 前端框架确认
- **选择**: Taro 4.x + React 19 + TypeScript
- **状态**: 🔴 **需要确认**
- **备选**: uni-app（Vue 生态，但与项目栈不一致）

### Q2: 微信小程序账号
- **现状**: 是否已有微信公众平台账号？
- **时间**: 申请小程序需要多长时间？
- **AppID**: 是否已准备好（开发阶段可用测试 ID）

### Q3: 后端 HTTPS 部署
- **需求**: 微信小程序要求后端为 https
- **时间**: Phase 4 还是更早部署？
- **域名**: 已有哪些可用域名？

### Q4: H5 版本
- **需求**: 是否需要 H5 网页版作为备用？
- **用途**: 管理后台、用户扩展、PC 访问？
- **优先级**: Phase 1 或 Phase 3？

### Q5: 现有 atomic 代码
- **情况**: 你已删除 atomic 目录
- **确认**: 确实不需要复用？还是计划后续整合？

---

## 下一步行动

1. **确认方案** (今天)
   - 审阅本讨论稿
   - 回答上述 Q1-Q5 问题
   - 反馈修改意见

2. **详细设计** (明天)
   - Taro 项目初始化脚本
   - 微信登录完整实现
   - 前后端接口规范（OpenAPI）

3. **启动开发** (后天)
   - 创建后端 auth 模块
   - 初始化前端 Taro 项目
   - 实现 Phase 1 功能

---

**讨论稿状态**: ⏳ 等待用户反馈

