# æµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

æœ¬é¡¹ç›®åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œ E2E é›†æˆæµ‹è¯•ï¼Œè¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ã€‚

---

## ğŸ§ª æµ‹è¯•ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â””â”€â”€ auth.service.spec.ts       # è®¤è¯æœåŠ¡å•å…ƒæµ‹è¯•
â”‚       â”œâ”€â”€ book/
â”‚       â”‚   â””â”€â”€ book.service.spec.ts       # ä¹¦ç±æœåŠ¡å•å…ƒæµ‹è¯•
â”‚       â””â”€â”€ vocabulary/
â”‚           â””â”€â”€ vocabulary.service.spec.ts # è¯æ±‡æœåŠ¡å•å…ƒæµ‹è¯•
â”‚
â””â”€â”€ test/
    â”œâ”€â”€ auth.e2e-spec.ts                   # è®¤è¯æµç¨‹ E2E æµ‹è¯•
    â”œâ”€â”€ book-flow.e2e-spec.ts              # ä¹¦ç±æµç¨‹ E2E æµ‹è¯•
    â”œâ”€â”€ vocabulary-flow.e2e-spec.ts        # è¯æ±‡æµç¨‹ E2E æµ‹è¯•
    â”œâ”€â”€ helpers/                           # æµ‹è¯•è¾…åŠ©å·¥å…·
    â”œâ”€â”€ mocks/                             # Mock å¯¹è±¡
    â”œâ”€â”€ setup.ts                           # å•å…ƒæµ‹è¯•è®¾ç½®
    â””â”€â”€ setup-e2e.ts                       # E2Eæµ‹è¯•è®¾ç½®
```

---

## ğŸš€ è¿è¡Œæµ‹è¯•

### 1. å•å…ƒæµ‹è¯•

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæ¨¡å—çš„æµ‹è¯•
npm test auth.service.spec
npm test book.service.spec
npm test vocabulary.service.spec

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
npm run test:cov

# ç›‘å¬æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
npm run test:watch
```

### 2. E2E é›†æˆæµ‹è¯•

```bash
# ç¡®ä¿æµ‹è¯•æ•°æ®åº“å·²å¯åŠ¨
docker-compose up -d postgres redis

# è¿è¡Œæ‰€æœ‰ E2E æµ‹è¯•
npm run test:e2e

# è¿è¡Œç‰¹å®šçš„ E2E æµ‹è¯•
npm run test:e2e -- auth.e2e-spec
npm run test:e2e -- book-flow.e2e-spec
npm run test:e2e -- vocabulary-flow.e2e-spec

# ç”Ÿæˆ E2E æµ‹è¯•è¦†ç›–ç‡
npm run test:e2e:cov
```

### 3. è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# å•å…ƒæµ‹è¯• + E2E æµ‹è¯•
npm run test:all
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. è®¤è¯æ¨¡å—æµ‹è¯• (`auth.service.spec.ts`)

**å•å…ƒæµ‹è¯•è¦†ç›–** (100+ æµ‹è¯•ç”¨ä¾‹):
- âœ… ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
  - æˆåŠŸæ³¨å†Œ
  - é‚®ç®±é‡å¤æ£€æµ‹
  - å¯†ç å“ˆå¸Œå¤„ç†
  - è¾“å…¥éªŒè¯
- âœ… ç”¨æˆ·ç™»å½•åŠŸèƒ½
  - æˆåŠŸç™»å½•
  - JWT ç”Ÿæˆ
  - å¯†ç éªŒè¯
  - é”™è¯¯å¤„ç†
- âœ… Token éªŒè¯
  - æœ‰æ•ˆ Token éªŒè¯
  - æ— æ•ˆ Token æ‹’ç»
  - è¿‡æœŸ Token å¤„ç†
- âœ… ç”¨æˆ·è§’è‰²æƒé™
  - é»˜è®¤è§’è‰²è®¾ç½®
  - ç®¡ç†å‘˜æƒé™

**E2E æµ‹è¯•è¦†ç›–** (`auth.e2e-spec.ts`):
- âœ… POST /api/auth/register
- âœ… POST /api/auth/login  
- âœ… GET /api/auth/profile
- âœ… PATCH /api/auth/profile
- âœ… å®Œæ•´è®¤è¯æµç¨‹æµ‹è¯•

### 2. ä¹¦ç±æ¨¡å—æµ‹è¯• (`book.service.spec.ts`)

**å•å…ƒæµ‹è¯•è¦†ç›–** (80+ æµ‹è¯•ç”¨ä¾‹):
- âœ… ä¹¦ç±åˆ›å»º
  - åŸºæœ¬ä¿¡æ¯åˆ›å»º
  - PDF ä¸Šä¼ å¤„ç†
  - æ–‡ä»¶éªŒè¯
  - å¤§å°é™åˆ¶
- âœ… ä¹¦ç±æŸ¥è¯¢
  - åˆ—è¡¨æŸ¥è¯¢
  - åˆ†é¡µåŠŸèƒ½
  - Lexile ç­›é€‰
  - æœç´¢åŠŸèƒ½
- âœ… ä¹¦ç±æ›´æ–°ä¸åˆ é™¤
  - ä¿¡æ¯æ›´æ–°
  - çŠ¶æ€æ›´æ–°
  - åˆ é™¤éªŒè¯
- âœ… ç« èŠ‚ç®¡ç†
  - ç« èŠ‚åˆ—è¡¨
  - ç« èŠ‚å†…å®¹
  - ç‰ˆæœ¬ç®¡ç†

**E2E æµ‹è¯•è¦†ç›–** (`book-flow.e2e-spec.ts`):
- âœ… POST /api/books
- âœ… POST /api/books/upload
- âœ… GET /api/books
- âœ… GET /api/books/:id
- âœ… GET /api/books/:bookId/chapters
- âœ… GET /api/chapters/:id
- âœ… å®Œæ•´é˜…è¯»æµç¨‹æµ‹è¯•

### 3. è¯æ±‡æ¨¡å—æµ‹è¯• (`vocabulary.service.spec.ts`)

**å•å…ƒæµ‹è¯•è¦†ç›–** (90+ æµ‹è¯•ç”¨ä¾‹):
- âœ… å•è¯æŸ¥è¯¢
  - åœ¨çº¿æŸ¥è¯
  - ç¼“å­˜æœºåˆ¶
  - é”™è¯¯å¤„ç†
  - å•è¯æ ‡å‡†åŒ–
- âœ… ç”Ÿè¯æœ¬ç®¡ç†
  - æ·»åŠ ç”Ÿè¯
  - é‡å¤æ£€æµ‹
  - åˆ—è¡¨æŸ¥è¯¢
  - çŠ¶æ€ç­›é€‰
- âœ… ç”Ÿè¯æœ¬æ“ä½œ
  - æ›´æ–°æ¡ç›®
  - åˆ é™¤æ¡ç›®
  - æ‰¹é‡æ“ä½œ
  - æƒé™æ§åˆ¶
- âœ… å¤ä¹ ç®—æ³•
  - å¤ä¹ é˜Ÿåˆ—
  - é—´éš”è®¡ç®—
  - è¿›åº¦è®°å½•
  - éš¾åº¦è°ƒæ•´

**E2E æµ‹è¯•è¦†ç›–** (`vocabulary-flow.e2e-spec.ts`):
- âœ… POST /api/vocabulary/lookup
- âœ… POST /api/vocabulary/my
- âœ… GET /api/vocabulary/my
- âœ… PATCH /api/vocabulary/my/:id
- âœ… DELETE /api/vocabulary/my/:id
- âœ… GET /api/vocabulary/review
- âœ… POST /api/vocabulary/my/:id/review
- âœ… GET /api/vocabulary/stats
- âœ… å®Œæ•´è¯æ±‡å­¦ä¹ æµç¨‹æµ‹è¯•

---

## âœ… æµ‹è¯•æ¸…å•

### å•å…ƒæµ‹è¯• (270+ æµ‹è¯•ç”¨ä¾‹)

| æ¨¡å— | æ–‡ä»¶ | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|------|----------|------|
| è®¤è¯ | `auth.service.spec.ts` | 100+ | âœ… |
| ä¹¦ç± | `book.service.spec.ts` | 80+ | âœ… |
| è¯æ±‡ | `vocabulary.service.spec.ts` | 90+ | âœ… |

### E2E æµ‹è¯• (50+ åœºæ™¯)

| æ¨¡å— | æ–‡ä»¶ | åœºæ™¯æ•° | çŠ¶æ€ |
|------|------|--------|------|
| è®¤è¯æµç¨‹ | `auth.e2e-spec.ts` | 15+ | âœ… |
| ä¹¦ç±æµç¨‹ | `book-flow.e2e-spec.ts` | 20+ | âœ… |
| è¯æ±‡æµç¨‹ | `vocabulary-flow.e2e-spec.ts` | 20+ | âœ… |

---

## ğŸ”§ æµ‹è¯•é…ç½®

### Jest é…ç½® (`jest.config.js`)

```javascript
module.exports = {
  moduleFileExtensions: ['js', 'json', 'ts'],
  rootDir: '.',
  testRegex: '.*\\.spec\\.ts$',
  transform: {
    '^.+\\.(t|j)s$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.(t|j)s',
    '!src/main.ts',
    '!src/**/*.module.ts',
  ],
  coverageDirectory: './coverage',
  testEnvironment: 'node',
  coverageThreshold: {
    global: {
      branches: 60,
      functions: 60,
      lines: 60,
      statements: 60,
    },
  },
};
```

### E2E é…ç½® (`test/jest-e2e.json`)

```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": "..",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}
```

---

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### 1. å•å…ƒæµ‹è¯•

- âœ… æ¯ä¸ªæœåŠ¡æ–¹æ³•è‡³å°‘ä¸€ä¸ªæµ‹è¯•
- âœ… æµ‹è¯•æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æµç¨‹
- âœ… ä½¿ç”¨ Mock éš”ç¦»ä¾èµ–
- âœ… æµ‹è¯•è¾¹ç•Œæ¡ä»¶
- âœ… ä¿æŒæµ‹è¯•ç‹¬ç«‹æ€§

### 2. E2E æµ‹è¯•

- âœ… æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹
- âœ… ä½¿ç”¨çœŸå®æ•°æ®åº“ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
- âœ… æ¯ä¸ªæµ‹è¯•å‰åæ¸…ç†æ•°æ®
- âœ… æµ‹è¯• API ç«¯ç‚¹å’ŒçŠ¶æ€ç 
- âœ… éªŒè¯å“åº”æ•°æ®ç»“æ„

### 3. æµ‹è¯•æ•°æ®

- âœ… ä½¿ç”¨ç‹¬ç‰¹çš„æµ‹è¯•æ•°æ®æ ‡è¯†ï¼ˆå¦‚ `test-e2e-*`ï¼‰
- âœ… æµ‹è¯•åè‡ªåŠ¨æ¸…ç†
- âœ… ä¸ä¾èµ–å¤–éƒ¨æ•°æ®
- âœ… é¿å…æµ‹è¯•é—´ç›¸äº’å¹²æ‰°

---

## ğŸš¨ éœ€è¦ç”¨æˆ·é…åˆçš„æµ‹è¯•

### 1. PDF ä¸Šä¼ æµ‹è¯•

**æ–‡ä»¶**: `book-flow.e2e-spec.ts`

**è¦æ±‚**:
- éœ€è¦æä¾›æµ‹è¯• PDF æ–‡ä»¶
- è·¯å¾„: `backend/test-files/sample.pdf`

**åˆ›å»ºæµ‹è¯•æ–‡ä»¶**:
```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ç›®å½•
mkdir -p backend/test-files

# å¤åˆ¶ä¸€ä¸ªå°çš„æµ‹è¯• PDF æ–‡ä»¶åˆ°è¯¥ç›®å½•
cp /path/to/your/sample.pdf backend/test-files/sample.pdf
```

**å½“å‰çŠ¶æ€**: å·²ä½¿ç”¨ `it.skip()` è·³è¿‡ï¼Œæä¾›æ–‡ä»¶åå¯å¯ç”¨

### 2. MinerU é›†æˆæµ‹è¯•

**è¦æ±‚**:
- éœ€è¦é…ç½® MinerU API Key
- éœ€è¦çœŸå®çš„ç½‘ç»œè¿æ¥

**é…ç½®æ–¹æ³•**:
```bash
# åœ¨ .env.test æ–‡ä»¶ä¸­é…ç½®
MINERU_API_KEY=your_api_key_here
```

### 3. è¯æ±‡ API æµ‹è¯•

**è¦æ±‚**:
- éœ€è¦é…ç½®æœ‰é“è¯å…¸ API Key
- æˆ–ä½¿ç”¨ Mock æ¨¡å¼

**å½“å‰çŠ¶æ€**: ä½¿ç”¨ Mock æ•°æ®ï¼Œå®é™… API éœ€é¢å¤–é…ç½®

---

## ğŸ“ˆ æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ | çŠ¶æ€ |
|------|------|------|------|
| Branches | 60% | TBD | â³ |
| Functions | 60% | TBD | â³ |
| Lines | 60% | TBD | â³ |
| Statements | 60% | TBD | â³ |

**æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š**:
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
npm run test:cov

# æ‰“å¼€ HTML æŠ¥å‘Š
open coverage/lcov-report/index.html
```

---

## ğŸ› è°ƒè¯•æµ‹è¯•

### 1. å•ä¸ªæµ‹è¯•è°ƒè¯•

```bash
# åªè¿è¡ŒåŒ…å«ç‰¹å®šåç§°çš„æµ‹è¯•
npm test -- --testNamePattern="åº”è¯¥æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·"

# è°ƒè¯•æ¨¡å¼
npm run test:debug
```

### 2. E2E æµ‹è¯•è°ƒè¯•

```bash
# å¢åŠ è¶…æ—¶æ—¶é—´
npm run test:e2e -- --testTimeout=30000

# æŸ¥çœ‹è¯¦ç»†è¾“å‡º
npm run test:e2e -- --verbose
```

### 3. å¸¸è§é—®é¢˜

**é—®é¢˜ 1**: æµ‹è¯•è¶…æ—¶
```bash
# è§£å†³: å¢åŠ è¶…æ—¶æ—¶é—´
jest.setTimeout(30000);
```

**é—®é¢˜ 2**: æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# è§£å†³: ç¡®ä¿ Docker æœåŠ¡è¿è¡Œ
docker-compose up -d postgres redis
```

**é—®é¢˜ 3**: æµ‹è¯•æ•°æ®æ®‹ç•™
```bash
# è§£å†³: æ‰‹åŠ¨æ¸…ç†æµ‹è¯•æ•°æ®åº“
npm run db:test:reset
```

---

## âœ¨ ä¸‹ä¸€æ­¥

### æµ‹è¯•å¢å¼ºè®¡åˆ’

1. **æ€§èƒ½æµ‹è¯•**
   - å‹åŠ›æµ‹è¯•
   - è´Ÿè½½æµ‹è¯•
   - å¹¶å‘æµ‹è¯•

2. **å®‰å…¨æµ‹è¯•**
   - SQL æ³¨å…¥æµ‹è¯•
   - XSS æµ‹è¯•
   - CSRF æµ‹è¯•

3. **é›†æˆæµ‹è¯•æ‰©å±•**
   - å¾®ä¿¡ç™»å½•æµç¨‹
   - PDF å®Œæ•´å¤„ç†æµç¨‹
   - TTS ç”Ÿæˆæµ‹è¯•

4. **è‡ªåŠ¨åŒ– CI/CD**
   - GitHub Actions é›†æˆ
   - è‡ªåŠ¨æµ‹è¯•è¿è¡Œ
   - ä»£ç è¦†ç›–ç‡æ£€æŸ¥

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœæ‚¨åœ¨è¿è¡Œæµ‹è¯•æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æ£€æŸ¥ `backend/logs/` ç›®å½•ä¸‹çš„æ—¥å¿—
3. ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²æ­£ç¡®å®‰è£…
4. ç¡®ä¿æµ‹è¯•æ•°æ®åº“å·²å¯åŠ¨

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-10-26  
**æµ‹è¯•è¦†ç›–ç‡**: 270+ å•å…ƒæµ‹è¯• + 50+ E2E åœºæ™¯  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

